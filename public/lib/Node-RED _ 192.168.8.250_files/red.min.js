/**
 * Copyright 2013, 2015 IBM Corp.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
var RED=function(){function a(){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"nodes",success:function(a){RED.nodes.setNodeList(a);for(var c=0,d=0;d<a.length;d++){var e=a[d];"node-red"!=e.module&&(c++,RED.i18n.loadCatalog(e.id,function(){c--,0===c&&b()}))}0===c&&b()}})}function b(){$.ajax({headers:{Accept:"text/html"},cache:!1,url:"nodes",success:function(a){$("body").append(a),$("body").i18n(),$(".palette-spinner").hide(),$(".palette-scroll").show(),$("#palette-search").show(),c()}})}function c(){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(a){RED.nodes["import"](a),RED.nodes.dirty(!1),RED.view.redraw(!0),RED.comms.subscribe("status/#",function(a,b){var c=a.split("/"),d=RED.nodes.node(c[1]);d&&(b.text&&(b.text=d._(b.text.toString(),{defaultValue:b.text.toString()})),d.status=b,f&&(d.dirty=!0,RED.view.redraw()))}),RED.comms.subscribe("node/#",function(a,b){var c,d,e,f;if("node/added"==a){var g=[];for(c=0;c<b.length;c++){d=b[c];var h=d.id;RED.nodes.addNodeSet(d),g=g.concat(d.types),$.get("nodes/"+h,function(a){$("body").append(a)})}g.length&&(e="<ul><li>"+g.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeAdded",{count:g.length})+e,"success"))}else if("node/removed"==a)for(c=0;c<b.length;c++)d=b[c],f=RED.nodes.removeNodeSet(d.id),f.added&&(e="<ul><li>"+d.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeRemoved",{count:d.types.length})+e,"success"));else"node/enabled"==a?b.types&&(f=RED.nodes.getNodeSet(b.id),f.added?(RED.nodes.enableNodeSet(b.id),e="<ul><li>"+b.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeEnabled",{count:b.types.length})+e,"success")):$.get("nodes/"+b.id,function(a){$("body").append(a),e="<ul><li>"+b.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeAdded",{count:b.types.length})+e,"success")})):"node/disabled"==a&&b.types&&(RED.nodes.disableNodeSet(b.id),e="<ul><li>"+b.types.join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeDisabled",{count:b.types.length})+e,"success"))})}})}function d(a){f=a,RED.view.status(f)}function e(){RED.menu.init({id:"btn-sidemenu",options:[{id:"menu-item-sidebar-menu",label:RED._("menu.label.sidebar.sidebar"),options:[{id:"menu-item-sidebar",label:RED._("menu.label.sidebar.show"),toggle:!0,onselect:RED.sidebar.toggleSidebar,selected:!0},null]},{id:"menu-item-status",label:RED._("menu.label.displayStatus"),toggle:!0,onselect:d,selected:!0},null,{id:"menu-item-import",label:RED._("menu.label.import"),options:[{id:"menu-item-import-clipboard",label:RED._("menu.label.clipboard"),onselect:RED.clipboard["import"]},{id:"menu-item-import-library",label:RED._("menu.label.library"),options:[]}]},{id:"menu-item-export",label:RED._("menu.label.export"),disabled:!0,options:[{id:"menu-item-export-clipboard",label:RED._("menu.label.clipboard"),disabled:!0,onselect:RED.clipboard["export"]},{id:"menu-item-export-library",label:RED._("menu.label.library"),disabled:!0,onselect:RED.library["export"]}]},null,{id:"menu-item-subflow",label:RED._("menu.label.subflows"),options:[{id:"menu-item-subflow-create",label:RED._("menu.label.createSubflow"),onselect:RED.subflow.createSubflow},{id:"menu-item-subflow-convert",label:RED._("menu.label.selectionToSubflow"),disabled:!0,onselect:RED.subflow.convertToSubflow}]},null,{id:"menu-item-workspace",label:RED._("menu.label.flows"),options:[{id:"menu-item-workspace-add",label:RED._("menu.label.add"),onselect:RED.workspaces.add},{id:"menu-item-workspace-edit",label:RED._("menu.label.rename"),onselect:RED.workspaces.edit},{id:"menu-item-workspace-delete",label:RED._("menu.label.delete"),onselect:RED.workspaces.remove},null]},null,{id:"menu-item-keyboard-shortcuts",label:RED._("menu.label.keyboardShortcuts"),onselect:RED.keyboard.showHelp},{id:"menu-item-help",label:RED.settings.theme("menu.menu-item-help.label","Node-RED Website"),href:RED.settings.theme("menu.menu-item-help.url","http://nodered.org/docs")}]}),RED.user.init(),RED.library.init(),RED.palette.init(),RED.sidebar.init(),RED.subflow.init(),RED.workspaces.init(),RED.clipboard.init(),RED.view.init(),RED.editor.init(),RED.deploy.init(RED.settings.theme("deployButton",null)),RED.keyboard.add(191,{shift:!0},function(){RED.keyboard.showHelp(),d3.event.preventDefault()}),RED.comms.connect(),$("#main-container").show(),$(".header-toolbar").show(),a()}var f=!1;return $(function(){"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname&&(document.title=document.title+" : "+window.location.hostname),ace.require("ace/ext/language_tools"),RED.i18n.init(function(){RED.settings.init(e)})}),{}}();RED.events=function(){function a(a,b){d[a]=d[a]||[],d[a].push(b)}function b(a,b){var c=d[a];if(c)for(var e=0;e<c.length;e++)if(c[e]===b)return void c.splice(e,1)}function c(a,b){if(d[a])for(var c=0;c<d[a].length;c++)d[a][c](b)}var d={};return{on:a,off:b,emit:c}}(),RED.i18n=function(){return{init:function(a){i18n.init({resGetPath:"locales/__ns__",dynamicLoad:!1,load:"current",ns:{namespaces:["editor","node-red"],defaultNs:"editor"},fallbackLng:["en-US"],useCookie:!1},function(){a()}),RED._=function(){return i18n.t.apply(null,arguments)}},loadCatalog:function(a,b){i18n.loadNamespace(a,b)}}}(),RED.settings=function(){function a(a,b){if(!RED.settings.editorTheme)return b;var c=a.split("."),d=RED.settings.editorTheme;try{for(var e=0;e<c.length;e++)d=d[c[e]];return d}catch(f){return b}}var b={},c=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(a){return!1}},d=function(a,b){c()&&localStorage.setItem(a,JSON.stringify(b))},e=function(a){return c()?JSON.parse(localStorage.getItem(a)):void 0},f=function(a){c()&&localStorage.removeItem(a)},g=function(a){for(var c in b)b.hasOwnProperty(c)&&RED.settings.hasOwnProperty(c)&&delete RED.settings[c];for(c in a)a.hasOwnProperty(c)&&(RED.settings[c]=a[c]);b=a},h=function(a){var b=/[?&]access_token=(.*?)(?:$|&)/.exec(window.location.search);if(b){var c=b[1];RED.settings.set("auth-tokens",{access_token:c}),window.location.search=""}$.ajaxSetup({beforeSend:function(a,b){if(!/^\s*(https?:|\/|\.)/.test(b.url)){var c=RED.settings.get("auth-tokens");c&&a.setRequestHeader("Authorization","Bearer "+c.access_token)}}}),i(a)},i=function(a){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings",success:function(b){g(b),RED.settings.user&&RED.settings.user.anonymous&&RED.settings.remove("auth-tokens"),console.log("Node-RED: "+b.version),a()},error:function(b,c,d){401===b.status?(/[?&]access_token=(.*?)(?:$|&)/.test(window.location.search)&&(window.location.search=""),RED.user.login(function(){i(a)})):console.log("Unexpected error:",b.status,c)}})};return{init:h,load:i,set:d,get:e,remove:f,theme:a}}(),RED.user=function(){function a(a,b){"function"==typeof a&&(b=a,a={});var c=$('<div id="node-dialog-login" class="hide"><div style="display: inline-block;width: 250px; vertical-align: top; margin-right: 10px; margin-bottom: 20px;"><img id="node-dialog-login-image" src=""/></div><div style="display: inline-block; width: 250px; vertical-align: bottom; margin-left: 10px; margin-bottom: 20px;"><form id="node-dialog-login-fields" class="form-horizontal" style="margin-bottom: 0px;"></form></div></div>');c.dialog({autoOpen:!1,dialogClass:"ui-dialog-no-close",modal:!0,closeOnEscape:!1,width:600,resizable:!1,draggable:!1}),$("#node-dialog-login-fields").empty(),$.ajax({dataType:"json",url:"auth/login",success:function(d){if("credentials"==d.type){var e=0;for(d.image?$("#node-dialog-login-image").attr("src",d.image):$("#node-dialog-login-image").attr("src","red/images/node-red-256.png");e<d.prompts.length;e++){var f=d.prompts[e],g=$("<div/>",{id:"rrr"+e,"class":"form-row"});$('<label for="node-dialog-login-'+f.id+'">'+f.label+":</label><br/>").appendTo(g);var h=$('<input style="width: 100%" id="node-dialog-login-'+f.id+'" type="'+f.type+'" tabIndex="'+(e+1)+'"/>').appendTo(g);e<d.prompts.length-1&&h.keypress(function(){var a=g;return function(b){13==b.keyCode&&(a.next("div").find("input").focus(),b.preventDefault())}}()),g.appendTo("#node-dialog-login-fields")}$('<div class="form-row" style="text-align: right; margin-top: 10px;"><span id="node-dialog-login-failed" style="line-height: 2em;float:left;" class="hide">'+RED._("user.loginFailed")+'</span><img src="red/images/spin.svg" style="height: 30px; margin-right: 10px; " class="login-spinner hide"/>'+(a.cancelable?'<a href="#" id="node-dialog-login-cancel" style="margin-right: 20px;" tabIndex="'+(e+1)+'">'+RED._("common.label.cancel")+"</a>":"")+'<input type="submit" id="node-dialog-login-submit" style="width: auto;" tabIndex="'+(e+2)+'" value="'+RED._("user.login")+'"></div>').appendTo("#node-dialog-login-fields"),$("#node-dialog-login-submit").button(),$("#node-dialog-login-fields").submit(function(a){$("#node-dialog-login-submit").button("option","disabled",!0),$("#node-dialog-login-failed").hide(),$(".login-spinner").show();for(var c={client_id:"node-red-editor",grant_type:"password",scope:""},e=0;e<d.prompts.length;e++){var f=d.prompts[e];c[f.id]=$("#node-dialog-login-"+f.id).val()}$.ajax({url:"auth/token",type:"POST",data:c}).done(function(a,c,d){RED.settings.set("auth-tokens",a),$("#node-dialog-login").dialog("destroy").remove(),b()}).fail(function(a,b,c){RED.settings.remove("auth-tokens"),$("#node-dialog-login-failed").show()}).always(function(){$("#node-dialog-login-submit").button("option","disabled",!1),$(".login-spinner").hide()}),a.preventDefault()}),a.cancelable&&$("#node-dialog-login-cancel").button().click(function(a){$("#node-dialog-login").dialog("destroy").remove()})}c.dialog("open")}})}function b(){$.ajax({url:"auth/revoke",type:"POST",data:{token:RED.settings.get("auth-tokens").access_token},success:function(){RED.settings.remove("auth-tokens"),document.location.reload(!0)}})}function c(){$("#usermenu-submenu li").remove(),RED.settings.user.anonymous?RED.menu.addItem("btn-usermenu",{id:"usermenu-item-login",label:RED._("menu.label.login"),onselect:function(){RED.user.login({cancelable:!0},function(){RED.settings.load(function(){RED.notify(RED._("user.loggedInAs",{name:RED.settings.user.username}),"success"),c()})})}}):(RED.menu.addItem("btn-usermenu",{id:"usermenu-item-username",label:"<b>"+RED.settings.user.username+"</b>"}),RED.menu.addItem("btn-usermenu",{id:"usermenu-item-logout",label:RED._("menu.label.logout"),onselect:function(){RED.user.logout()}}))}function d(){RED.settings.user&&(RED.settings.editorTheme&&RED.settings.editorTheme.hasOwnProperty("userMenu")||($('<li><a id="btn-usermenu" class="button hide" data-toggle="dropdown" href="#"><i class="fa fa-user"></i></a></li>').prependTo(".header-toolbar"),RED.menu.init({id:"btn-usermenu",options:[]}),c()))}return{init:d,login:a,logout:b}}(),RED.comms=function(){function a(){function b(){for(var a in g)g.hasOwnProperty(a)&&d.send(JSON.stringify({subscribe:a}))}var c=location.hostname,j=location.port;0!==j.length&&(c=c+":"+j),c+=document.location.pathname,c=c+("/"==c.slice(-1)?"":"/")+"comms",c="ws"+("https:"==document.location.protocol?"s":"")+"://"+c;var k=RED.settings.get("auth-tokens");h=null!=k,d=new WebSocket(c),d.onopen=function(){i=0,e&&(f=setTimeout(function(){e.close(),e=null},1e3)),h?d.send(JSON.stringify({auth:k.access_token})):b()},d.onmessage=function(a){var c=JSON.parse(a.data);if(h&&"ok"==c.auth)h=!1,b();else if(c.topic)for(var d in g)if(g.hasOwnProperty(d)){var e=new RegExp("^"+d.replace(/([\[\]\?\(\)\\\\$\^\*\.|])/g,"\\$1").replace(/\+/g,"[^/]+").replace(/\/#$/,"(/.*)?")+"$");if(e.test(c.topic)){var f=g[d];if(f)for(var i=0;i<f.length;i++)f[i](c.topic,c.data)}}},d.onclose=function(){i>5&&null==e?e=RED.notify(RED._("notification.error",{message:RED._("notification.errors.lostConnection")}),"error",!0):f&&(clearTimeout(f),f=null),i++,setTimeout(a,1e3)}}function b(a,b){null==g[a]&&(g[a]=[]),g[a].push(b),d&&1==d.readyState&&d.send(JSON.stringify({subscribe:a}))}function c(a,b){if(g[a]){for(var c=0;c<g[a].length;c++)if(g[a][c]===b){g[a].splice(c,1);break}0===g[a].length&&delete g[a]}}var d,e=null,f=null,g={},h=!1,i=0;return{connect:a,subscribe:b,unsubscribe:c}}(),RED.state={DEFAULT:0,MOVING:1,JOINING:2,MOVING_ACTIVE:3,ADDING:4,EDITING:5,EXPORT:6,IMPORT:7,IMPORT_DRAGGING:8},RED.nodes=function(){function a(a){F=a,RED.events.emit("nodes:change",{dirty:F})}function b(){return(1+4294967295*Math.random()).toString(16)}function c(a){if(0!==a.type.indexOf("subflow")&&(a._=a._def._),"config"==a._def.category)B[a.id]=a;else{a.dirty=!0;var b=!1;for(var c in a._def.defaults)if(a._def.defaults.hasOwnProperty(c)){var d=a._def.defaults[c];if(d.type){var e=G.getNodeType(d.type);if(e&&"config"==e.category){var f=B[a[c]];f&&(b=!0,f.users.push(a))}}}if("subflows"==a._def.category&&"undefined"==typeof a.i){var g=0;RED.nodes.eachNode(function(a){g=Math.max(g,a.i||0)}),a.i=g+1}A.push(a)}a._def.onadd&&a._def.onadd.call(a)}function d(a){C.push(a)}function e(a){if(a in B)return B[a];for(var b in A)if(A[b].id==a)return A[b];return null}function f(a){var b,c=[],d=[];if(a in B)b=B[a],delete B[a],RED.workspaces.refresh();else if(b=e(a)){A.splice(A.indexOf(b),1),c=C.filter(function(a){return a.source===b||a.target===b}),c.forEach(function(a){C.splice(C.indexOf(a),1)});var g=!1;for(var h in b._def.defaults)if(b._def.defaults.hasOwnProperty(h)){var i=b._def.defaults[h];if(i.type){var j=G.getNodeType(i.type);if(j&&"config"==j.category){var k=B[b[h]];if(k)if(g=!0,k._def.exclusive)f(b[h]),d.push(k);else{var l=k.users;l.splice(l.indexOf(b),1)}}}}g&&RED.workspaces.refresh()}return b&&b._def.onremove&&b._def.onremove.call(n),{links:c,nodes:d}}function g(a){var b=C.indexOf(a);-1!=b&&C.splice(b,1)}function h(a){D[a.id]=a}function j(a){return D[a]}function k(a){delete D[a];var b,c,d=[],e=[];for(b=0;b<A.length;b++)c=A[b],c.z==a&&d.push(c);for(b in B)B.hasOwnProperty(b)&&(c=B[b],c.z==a&&d.push(c));for(b=0;b<d.length;b++){var g=f(d[b].id);e=e.concat(g.links)}return{nodes:d,links:e}}function l(a,b){if(b){var c=Object.keys(E).map(function(a){return E[a].name});c.sort();var d=1,e=a.name;c.forEach(function(b){e==b&&(d++,e=a.name+" ("+d+")")}),a.name=e}E[a.id]=a,RED.nodes.registerType("subflow:"+a.id,{defaults:{name:{value:""}},info:a.info,icon:"subflow.png",category:"subflows",inputs:a["in"].length,outputs:a.out.length,color:"#da9",label:function(){return this.name||RED.nodes.subflow(a.id).name},labelStyle:function(){return this.name?"node_label_italic":""},paletteLabel:function(){return RED.nodes.subflow(a.id).name},set:{module:"node-red"}})}function m(a){return E[a]}function o(a){delete E[a.id],G.removeNodeType("subflow:"+a.id)}function p(a,b){for(var c=0;c<A.length;c++){var d=A[c];if(d.z===a){var e=/^subflow:(.+)$/.exec(d.type);if(e){if(e[1]===b)return!0;var f=p(e[1],b);if(f)return!0}}}return!1}function q(a){var b={};b[a.id]=!0;for(var c=[a],d=[a];0!==d.length;)for(var e=d.shift(),f=C.filter(function(a){return a.source===e||a.target===e}),g=0;g<f.length;g++){var h=f[g].source===e?f[g].target:f[g].source,i=h.id;i||(i=h.direction+":"+h.i),b[i]||(b[i]=!0,c.push(h),d.push(h))}return c}function r(a,b){b=b||!1;var c={};if(c.id=a.id,c.type=a.type,c.z=a.z,"unknown"==c.type)for(var d in a._orig)a._orig.hasOwnProperty(d)&&(c[d]=a._orig[d]);else{for(var e in a._def.defaults)a._def.defaults.hasOwnProperty(e)&&(c[e]=a[e]);if(b&&a.credentials){var f={};c.credentials={};for(var g in a._def.credentials)a._def.credentials.hasOwnProperty(g)&&("password"==a._def.credentials[g].type?(a.credentials["has_"+g]!=a.credentials._["has_"+g]||a.credentials["has_"+g]&&a.credentials[g])&&(f[g]=a.credentials[g]):null!=a.credentials[g]&&a.credentials[g]!=a.credentials._[g]&&(f[g]=a.credentials[g]));Object.keys(f).length>0&&(c.credentials=f)}}if("config"!=a._def.category){c.x=a.x,c.y=a.y,c.wires=[];for(var h=0;h<a.outputs;h++)c.wires.push([]);for(var i=C.filter(function(b){return b.source===a}),j=0;j<i.length;j++){var k=i[j];"subflow"!=k.target.type&&c.wires[k.sourcePort].push(k.target.id)}}return c}function s(a){var b={};return b.id=a.id,b.type=a.type,b.name=a.name,b.info=a.info,b["in"]=[],b.out=[],a["in"].forEach(function(a){for(var c={x:a.x,y:a.y,wires:[]},d=C.filter(function(b){return b.source===a}),e=0;e<d.length;e++){var f=d[e];"subflow"!=f.target.type&&c.wires.push({id:f.target.id})}b["in"].push(c)}),a.out.forEach(function(c,d){var e={x:c.x,y:c.y,wires:[]},f=C.filter(function(a){return a.target===c});for(i=0;i<f.length;i++)"subflow"!=f[i].source.type?e.wires.push({id:f[i].source.id,port:f[i].sourcePort}):e.wires.push({id:a.id,port:0});b.out.push(e)}),b}function t(a){for(var b=[],c={},d={},e=0;e<a.length;e++){var f=a[e];if("subflow:"==f.type.substring(0,8)){var g=f.type.substring(8);if(!d[g]){d[g]=!0;var h=m(g),i=[h];RED.nodes.eachNode(function(a){a.z==g&&i.push(a)});var j=t(i);b=j.concat(b)}}if("subflow"!=f.type){var k=RED.nodes.convertNode(f);for(var l in f._def.defaults)if(f._def.defaults[l].type&&f[l]in B){var n=B[f[l]],o=G.getNodeType(f._def.defaults[l].type).exportable;null==o||o?f[l]in c||(c[f[l]]=!0,b.unshift(RED.nodes.convertNode(n))):k[l]=""}b.push(k)}else{var p=s(f);b.push(p)}}return b}function u(){var a,b=[];for(a in D)D.hasOwnProperty(a)&&"tab"==D[a].type&&b.push(D[a]);for(a in E)E.hasOwnProperty(a)&&b.push(s(E[a]));for(a in B)B.hasOwnProperty(a)&&b.push(r(B[a],!0));for(a=0;a<A.length;a++){var c=A[a];b.push(r(c,!0))}return b}function v(a,b,c){if(c&&a.id!=b.id)return!1;if(a.type!=b.type)return!1;var d=a._def;for(var e in d.defaults)if(d.defaults.hasOwnProperty(e)){var f=a[e],g=b[e];if(typeof f!=typeof g)return!1;if(null===f||"string"==typeof f||"number"==typeof f){if(f!==g)return!1}else if(JSON.stringify(f)!==JSON.stringify(g))return!1}return!0}function w(a,e){var f,g,i;if("string"==typeof a){if(""===a)return;try{i=JSON.parse(a)}catch(j){var k=new Error(RED._("clipboard.invalidFlow",{message:j.message}));throw k.code="NODE_RED",k}}else i=a;$.isArray(i)||(i=[i]);var n=[];for(f=0;f<i.length;f++)g=i[f],"workspace"==g.type||"tab"==g.type||"subflow"==g.type||G.getNodeType(g.type)||"subflow:"==g.type.substring(0,8)||-1!=n.indexOf(g.type)||n.push(g.type);if(n.length>0){var o="<ul><li>"+n.join("</li><li>")+"</li></ul>";"type"+(n.length>1?"s":"");RED.notify("<strong>"+RED._("clipboard.importUnrecognised",{count:n.length})+"</strong>"+o,"error",!1,1e4)}var q=RED.workspaces.active(),r=m(q);if(r)for(f=0;f<i.length;f++){var s=/^subflow:(.+)$/.exec(i[f].type);if(s){var j,t=s[1];if(t===r.id&&(j=new Error(RED._("notification.errors.cannotAddSubflowToItself"))),p(s[1],r.id)&&(j=new Error(RED._("notification.errors.cannotAddCircularReference"))),j)throw j.code="NODE_RED",j}}var u,w,x=[],y={},A=[],C={},E={},F=[],H=[];for(f=0;f<i.length;f++)g=i[f],"workspace"===g.type||"tab"===g.type?("workspace"===g.type&&(g.type="tab"),null==z&&(z=g),e&&(u=b(),y[g.id]=u,g.id=u),h(g),RED.workspaces.add(g),x.push(g)):"subflow"===g.type&&(C[g.id]=g,e&&(u=b(),g.id=u),g["in"].forEach(function(a,c){a.type="subflow",a.direction="in",a.z=g.id,a.i=c,a.id=b()}),g.out.forEach(function(a,c){a.type="subflow",a.direction="out",a.z=g.id,a.i=c,a.id=b()}),A.push(g),l(g,e));for(null==z&&(z={type:"tab",id:b(),label:RED._("workspace.defaultName",{number:1})},h(z),RED.workspaces.add(z),x.push(z),q=RED.workspaces.active()),f=0;f<i.length;f++)if(g=i[f],w=G.getNodeType(g.type),w&&"config"==w.category){var I=null;if(e&&(g.z&&(C[g.z]?g.z=C[g.z].id:(g.z=y[g.z],D[g.z]||(g.z=q))),I=RED.nodes.node(g.id),I&&g.z&&I.z!==g.z)){I=null;for(var J in B)if(B.hasOwnProperty(J)&&B[J].z===g.z&&v(B[J],g,!1)){I=B[J],E[g.id]=B[J];break}}if(!I){var K={id:g.id,z:g.z,type:g.type,users:[]};for(var L in w.defaults)w.defaults.hasOwnProperty(L)&&(K[L]=g[L]);K.label=w.label,K._def=w,e&&(K.id=b()),E[g.id]=K,F.push(K),RED.nodes.add(K)}}for(f=0;f<i.length;f++)if(g=i[f],"workspace"!==g.type&&"tab"!==g.type&&"subflow"!==g.type&&(w=G.getNodeType(g.type),!w||"config"!=w.category)){var M={x:g.x,y:g.y,z:g.z,type:0,wires:g.wires,changed:!1};if(e?(C[M.z]?M.z=C[M.z].id:(M.z=y[M.z],D[M.z]||(M.z=q)),M.id=b()):(M.id=g.id,(null==M.z||!D[M.z]&&!C[M.z])&&(M.z=q)),M.type=g.type,M._def=w,"subflow"===g.type.substring(0,7)){var N=g.type.split(":")[1],O=C[N]||m(N);e&&(N=O.id,M.type="subflow:"+N,M._def=G.getNodeType(M.type),delete M.i),M.name=g.name,M.outputs=O.out.length,M.inputs=O["in"].length}else{if(!M._def){M.x&&M.y?M._def={color:"#fee",defaults:{},label:"unknown: "+g.type,labelStyle:"node_label_italic",outputs:g.outputs||g.wires.length,set:G.getNodeSet("node-red/unknown")}:(M._def={category:"config",set:G.getNodeSet("node-red/unknown")},M.users=[]);var P={};for(var Q in g)g.hasOwnProperty(Q)&&"x"!=Q&&"y"!=Q&&"z"!=Q&&"id"!=Q&&"wires"!=Q&&(P[Q]=g[Q]);M._orig=P,M.name=g.type,M.type="unknown"}if("config"!=M._def.category){M.inputs=g.inputs||M._def.inputs,M.outputs=g.outputs||M._def.outputs;for(var R in M._def.defaults)M._def.defaults.hasOwnProperty(R)&&(M._def.defaults[R].type&&E[g[R]]?M[R]=E[g[R]].id:M[R]=g[R])}}c(M),RED.editor.validateNode(M),E[g.id]=M,"config"!=M._def.category&&F.push(M)}for(f=0;f<F.length;f++)if(g=F[f],g.wires){for(var S=0;S<g.wires.length;S++)for(var T=g.wires[S]instanceof Array?g.wires[S]:[g.wires[S]],U=0;U<T.length;U++)if(T[U]in E){var V={source:g,sourcePort:S,target:E[T[U]]};d(V),H.push(V)}delete g.wires}for(f=0;f<A.length;f++)g=A[f],g["in"].forEach(function(a){a.wires.forEach(function(b){var c={source:a,sourcePort:0,target:E[b.id]};d(c),H.push(c)}),delete a.wires}),g.out.forEach(function(a){a.wires.forEach(function(b){var c;c=C[b.id]&&C[b.id].id==g.id?{source:g["in"][b.port],sourcePort:b.port,target:a}:{source:E[b.id]||C[b.id],sourcePort:b.port,target:a},d(c),H.push(c)}),delete a.wires});return RED.workspaces.refresh(),[F,H,x,A]}function x(a){for(var b=[],c=0;c<A.length;c++){var d=A[c];a.hasOwnProperty("z")&&d.z!==a.z||a.hasOwnProperty("type")&&d.type!==a.type||b.push(d)}return b}function y(a){for(var b=[],c=0;c<C.length;c++){var d=C[c];if(a.source){if(a.source.hasOwnProperty("id")&&d.source.id!==a.source.id)continue;if(a.source.hasOwnProperty("z")&&d.source.z!==a.source.z)continue}if(a.target){if(a.target.hasOwnProperty("id")&&d.target.id!==a.target.id)continue;if(a.target.hasOwnProperty("z")&&d.target.z!==a.target.z)continue}a.hasOwnProperty("sourcePort")&&d.sourcePort!==a.sourcePort||b.push(d)}return b}var z,A=[],B={},C=[],D={},E={},F=!1,G=function(){var a=[],b={},c={},d={},e={getNodeList:function(){return a},setNodeList:function(b){a=[];for(var c=0;c<b.length;c++){var d=b[c];e.addNodeSet(d)}},addNodeSet:function(d){d.added=!1,b[d.id]=d;for(var e=0;e<d.types.length;e++)c[d.types[e]]=d.id;a.push(d)},removeNodeSet:function(e){for(var f=b[e],g=0;g<f.types.length;g++){if(f.added){RED.palette.remove(f.types[g]);var h=d[f.types[g]];h.onpaletteremove&&"function"==typeof h.onpaletteremove&&h.onpaletteremove.call(h)}delete c[f.types[g]]}delete b[e];for(var i=0;i<a.length;i++)if(a[i].id==e){a.splice(i,1);break}return f},getNodeSet:function(a){return b[a]},enableNodeSet:function(a){var c=b[a];c.enabled=!0;for(var e=0;e<c.types.length;e++){RED.palette.show(c.types[e]);var f=d[c.types[e]];f.onpaletteadd&&"function"==typeof f.onpaletteadd&&f.onpaletteadd.call(f)}},disableNodeSet:function(a){var c=b[a];c.enabled=!1;for(var e=0;e<c.types.length;e++){RED.palette.hide(c.types[e]);var f=d[c.types[e]];f.onpaletteremove&&"function"==typeof f.onpaletteremove&&f.onpaletteremove.call(f)}},registerNodeType:function(a,e){if(d[a]=e,"subflows"!=e.category){e.set=b[c[a]],b[c[a]].added=!0;var f;f="node-red"===e.set.module?"node-red":e.set.id,e._=function(){var a=Array.prototype.slice.call(arguments,0);return-1===a[0].indexOf(":")&&(a[0]=f+":"+a[0]),RED._.apply(null,a)}}RED.palette.add(a,e),e.onpaletteadd&&"function"==typeof e.onpaletteadd&&e.onpaletteadd.call(e)},removeNodeType:function(a){if("subflow:"!=a.substring(0,8))throw new Error("this api is subflow only. called with:",a);delete d[a],RED.palette.remove(a)},getNodeType:function(a){return d[a]}};return e}();return{registry:G,setNodeList:G.setNodeList,getNodeSet:G.getNodeSet,addNodeSet:G.addNodeSet,removeNodeSet:G.removeNodeSet,enableNodeSet:G.enableNodeSet,disableNodeSet:G.disableNodeSet,registerType:G.registerNodeType,getType:G.getNodeType,convertNode:r,add:c,remove:f,addLink:d,removeLink:g,addWorkspace:h,removeWorkspace:k,workspace:j,addSubflow:l,removeSubflow:o,subflow:m,subflowContains:p,eachNode:function(a){for(var b=0;b<A.length;b++)a(A[b])},eachLink:function(a){for(var b=0;b<C.length;b++)a(C[b])},eachConfig:function(a){for(var b in B)B.hasOwnProperty(b)&&a(B[b])},eachSubflow:function(a){for(var b in E)E.hasOwnProperty(b)&&a(E[b])},eachWorkspace:function(a){for(var b in D)D.hasOwnProperty(b)&&a(D[b])},node:e,filterNodes:x,filterLinks:y,"import":w,getAllFlowNodes:q,createExportableNodeSet:t,createCompleteNodeSet:u,id:b,dirty:function(b){return null==b?F:void a(b)}}}(),RED.history=function(){var a=[];return{markAllDirty:function(){for(var b=0;b<a.length;b++)a[b].dirty=!0},depth:function(){return a.length},push:function(b){a.push(b)},pop:function(){var b,c,d,e=a.pop(),f={};if(e){if("add"==e.t){if(e.nodes)for(b=0;b<e.nodes.length;b++)c=RED.nodes.node(e.nodes[b]),c.z&&(f[c.z]=!0),RED.nodes.remove(e.nodes[b]);if(e.links)for(b=0;b<e.links.length;b++)RED.nodes.removeLink(e.links[b]);if(e.workspaces)for(b=0;b<e.workspaces.length;b++)RED.nodes.removeWorkspace(e.workspaces[b].id),RED.workspaces.remove(e.workspaces[b]);if(e.subflows)for(b=0;b<e.subflows.length;b++)RED.nodes.removeSubflow(e.subflows[b]),RED.workspaces.remove(e.subflows[b]);e.subflow&&(e.subflow.instances&&e.subflow.instances.forEach(function(a){var b=RED.nodes.node(a.id);b&&(b.changed=a.changed,b.dirty=!0)}),e.subflow.hasOwnProperty("changed")&&(d=RED.nodes.subflow(e.subflow.id),d&&(d.changed=e.subflow.changed)))}else if("delete"==e.t){if(e.workspaces)for(b=0;b<e.workspaces.length;b++)RED.nodes.addWorkspace(e.workspaces[b]),RED.workspaces.add(e.workspaces[b]);if(e.subflow&&e.subflow.subflow&&RED.nodes.addSubflow(e.subflow.subflow),e.subflowInputs&&e.subflowInputs.length>0&&(d=RED.nodes.subflow(e.subflowInputs[0].z),d["in"].push(e.subflowInputs[0]),d["in"][0].dirty=!0),e.subflowOutputs&&e.subflowOutputs.length>0)for(d=RED.nodes.subflow(e.subflowOutputs[0].z),e.subflowOutputs.sort(function(a,b){return a.i-b.i}),b=0;b<e.subflowOutputs.length;b++){var g=e.subflowOutputs[b];d.out.splice(g.i,0,g);for(var h=g.i+1;h<d.out.length;h++)d.out[h].i++,d.out[h].dirty=!0;RED.nodes.eachLink(function(a){a.source.type=="subflow:"+d.id&&a.sourcePort>=g.i&&a.sourcePort++})}if(e.subflow&&e.subflow.hasOwnProperty("instances")&&e.subflow.instances.forEach(function(a){var b=RED.nodes.node(a.id);b&&(b.changed=a.changed,b.dirty=!0)}),d&&RED.nodes.filterNodes({type:"subflow:"+d.id}).forEach(function(a){for(a.inputs=d["in"].length,a.outputs=d.out.length;a.outputs>a.ports.length;)a.ports.push(a.ports.length);a.resize=!0,a.dirty=!0}),e.nodes)for(b=0;b<e.nodes.length;b++)RED.nodes.add(e.nodes[b]),f[e.nodes[b].z]=!0;if(e.links)for(b=0;b<e.links.length;b++)RED.nodes.addLink(e.links[b]);if(e.changes)for(b in e.changes)if(e.changes.hasOwnProperty(b)&&(c=RED.nodes.node(b))){for(var i in e.changes[b])e.changes[b].hasOwnProperty(i)&&(c[i]=e.changes[b][i]);c.dirty=!0}}else if("move"==e.t)for(b=0;b<e.nodes.length;b++){var j=e.nodes[b];j.n.x=j.ox,j.n.y=j.oy,j.n.dirty=!0}else if("edit"==e.t){for(b in e.changes)if(e.changes.hasOwnProperty(b)){if(e.node._def.defaults[b].type){var k=RED.nodes.node(e.node[b]);k&&k.users.splice(k.users.indexOf(e.node),1);var l=RED.nodes.node(e.changes[b]);l&&l.users.push(e.node)}e.node[b]=e.changes[b]}if(e.subflow?(e.subflow.hasOwnProperty("inputCount")&&(e.node["in"].length>e.subflow.inputCount?e.node["in"].splice(e.subflow.inputCount):e.subflow.inputs.length>0&&(e.node["in"]=e.node["in"].concat(e.subflow.inputs))),e.subflow.hasOwnProperty("outputCount")&&(e.node.out.length>e.subflow.outputCount?e.node.out.splice(e.subflow.outputCount):e.subflow.outputs.length>0&&(e.node.out=e.node.out.concat(e.subflow.outputs))),e.subflow.hasOwnProperty("instances")&&e.subflow.instances.forEach(function(a){var b=RED.nodes.node(a.id);b&&(b.changed=a.changed,b.dirty=!0)}),RED.nodes.filterNodes({type:"subflow:"+e.node.id}).forEach(function(a){a.inputs=e.node["in"].length,a.outputs=e.node.out.length,RED.editor.updateNodeProperties(a)}),"subflow"===e.node.type&&$("#menu-item-workspace-menu-"+e.node.id.replace(".","-")).text(e.node.name)):(RED.editor.updateNodeProperties(e.node),RED.editor.validateNode(e.node)),e.links)for(b=0;b<e.links.length;b++)RED.nodes.addLink(e.links[b]);e.node.dirty=!0,e.node.changed=e.changed}else if("createSubflow"==e.t){if(e.nodes)for(RED.nodes.filterNodes({z:e.subflow.subflow.id}).forEach(function(a){a.z=e.activeWorkspace,a.dirty=!0}),b=0;b<e.nodes.length;b++)RED.nodes.remove(e.nodes[b]);if(e.links)for(b=0;b<e.links.length;b++)RED.nodes.removeLink(e.links[b]);if(RED.nodes.removeSubflow(e.subflow.subflow),RED.workspaces.remove(e.subflow.subflow),e.removedLinks)for(b=0;b<e.removedLinks.length;b++)RED.nodes.addLink(e.removedLinks[b])}Object.keys(f).forEach(function(a){var b=RED.nodes.subflow(a);b&&RED.editor.validateNode(b)}),RED.nodes.dirty(e.dirty),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh()}}}}(),RED.validators={number:function(){return function(a){return""!==a&&!isNaN(a)}},regex:function(a){return function(b){return a.test(b)}}},RED.deploy=function(){function a(a){h=a,$("#btn-deploy img").attr("src",f[a].img)}function b(b){b=b||{};var c=b.type||"default";if("default"==c)$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><img id="btn-deploy-icon" src="red/images/deploy-full-o.png"> <span>'+RED._("deploy.deploy")+'</span></a><a id="btn-deploy-options" data-toggle="dropdown" class="deploy-button" href="#"><i class="fa fa-caret-down"></i></a></span></li>').prependTo(".header-toolbar"),RED.menu.init({id:"btn-deploy-options",options:[{id:"deploymenu-item-full",toggle:"deploy-type",icon:"red/images/deploy-full.png",label:RED._("deploy.full"),sublabel:RED._("deploy.fullDesc"),selected:!0,onselect:function(b){b&&a("full")}},{id:"deploymenu-item-flow",toggle:"deploy-type",icon:"red/images/deploy-flows.png",label:RED._("deploy.modifiedFlows"),sublabel:RED._("deploy.modifiedFlowsDesc"),onselect:function(b){b&&a("flows")}},{id:"deploymenu-item-node",toggle:"deploy-type",icon:"red/images/deploy-nodes.png",label:RED._("deploy.modifiedNodes"),sublabel:RED._("deploy.modifiedNodesDesc"),onselect:function(b){b&&a("nodes")}}]});else if("simple"==c){var d=b.label||RED._("deploy.deploy"),f="red/images/deploy-full-o.png";b.hasOwnProperty("icon")&&(f=b.icon),$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#">'+(f?'<img id="btn-deploy-icon" src="'+f+'"> ':"")+"<span>"+d+"</span></a></span></li>").prependTo(".header-toolbar")}$("#btn-deploy").click(function(){e()}),$("#node-dialog-confirm-deploy").dialog({title:"Confirm deploy",modal:!0,autoOpen:!1,width:550,height:"auto",buttons:[{text:RED._("deploy.confirm.button.confirm"),click:function(){var a=$("#node-dialog-confirm-deploy-hide").prop("checked");a&&(g[$("#node-dialog-confirm-deploy-type").val()]=!0),e(!0),$(this).dialog("close")}},{text:RED._("deploy.confirm.button.cancel"),click:function(){$(this).dialog("close")}}],create:function(){$("#node-dialog-confirm-deploy").parent().find("div.ui-dialog-buttonpane").prepend('<div style="height:0; vertical-align: middle; display:inline-block; margin-top: 13px; float:left;"><input style="vertical-align:top;" type="checkbox" id="node-dialog-confirm-deploy-hide"><label style="display:inline;" for="node-dialog-confirm-deploy-hide"> do not warn about this again</label><input type="hidden" id="node-dialog-confirm-deploy-type"></div>')}}),RED.events.on("nodes:change",function(a){a.dirty?(window.onbeforeunload=function(){return RED._("deploy.confirm.undeployedChanges")},$("#btn-deploy").removeClass("disabled")):(window.onbeforeunload=null,$("#btn-deploy").addClass("disabled"));
})}function c(a){var b="";if(a.z){var c=RED.nodes.workspace(a.z);c?b=c.label:(c=RED.nodes.subflow(a.z),b=c.name)}var d="";return d="function"==typeof a._def.label?a._def.label.call(a):a._def.label,d=d||a.id,{tab:b,type:a.type,label:d}}function d(a,b){return a.tab<b.tab?-1:a.tab>b.tab?1:a.type<b.type?-1:a.type>b.type?1:a.name<b.name?-1:a.name>b.name?1:0}function e(a){if(RED.nodes.dirty()){if(!a){var b=!1,e=!1,f=!1,i=[],j=[];RED.nodes.eachNode(function(a){e=e||!a.valid,a.valid||j.push(c(a)),"unknown"===a.type&&-1==i.indexOf(a.name)&&i.push(a.name)}),b=i.length>0;var k=[];RED.nodes.eachConfig(function(a){0===a.users.length&&(k.push(c(a)),f=!0)}),$("#node-dialog-confirm-deploy-config").hide(),$("#node-dialog-confirm-deploy-unknown").hide(),$("#node-dialog-confirm-deploy-unused").hide();var l=!1;if(b&&!g.unknown?(l=!0,$("#node-dialog-confirm-deploy-type").val("unknown"),$("#node-dialog-confirm-deploy-unknown").show(),$("#node-dialog-confirm-deploy-unknown-list").html("<li>"+i.join("</li><li>")+"</li>")):e&&!g.invalid?(l=!0,$("#node-dialog-confirm-deploy-type").val("invalid"),$("#node-dialog-confirm-deploy-config").show(),j.sort(d),$("#node-dialog-confirm-deploy-invalid-list").html("<li>"+j.map(function(a){return(a.tab?"["+a.tab+"] ":"")+a.label+" ("+a.type+")"}).join("</li><li>")+"</li>")):f&&!g.unusedConfig&&(l=!0,$("#node-dialog-confirm-deploy-type").val("unusedConfig"),$("#node-dialog-confirm-deploy-unused").show(),k.sort(d),$("#node-dialog-confirm-deploy-unused-list").html("<li>"+k.map(function(a){return(a.tab?"["+a.tab+"] ":"")+a.label+" ("+a.type+")"}).join("</li><li>")+"</li>")),l)return $("#node-dialog-confirm-deploy-hide").prop("checked",!1),void $("#node-dialog-confirm-deploy").dialog("open")}var m=RED.nodes.createCompleteNodeSet();$("#btn-deploy-icon").removeClass("fa-download"),$("#btn-deploy-icon").addClass("spinner"),RED.nodes.dirty(!1),$.ajax({url:"flows",type:"POST",data:JSON.stringify(m),contentType:"application/json; charset=utf-8",headers:{"Node-RED-Deployment-Type":h}}).done(function(a,b,c){RED.notify(RED._("deploy.successfulDeploy"),"success"),RED.nodes.eachNode(function(a){a.changed&&(a.dirty=!0,a.changed=!1),a.credentials&&delete a.credentials}),RED.nodes.eachConfig(function(a){a.credentials&&delete a.credentials}),RED.history.markAllDirty(),RED.view.redraw(),RED.events.emit("deploy")}).fail(function(a,b,c){RED.nodes.dirty(!0),a.responseText?RED.notify(RED._("notification.error",{message:a.responseText}),"error"):RED.notify(RED._("notification.error",{message:RED._("deploy.errors.noResponse")}),"error")}).always(function(){$("#btn-deploy-icon").removeClass("spinner"),$("#btn-deploy-icon").addClass("fa-download")})}}var f={full:{img:"red/images/deploy-full-o.png"},nodes:{img:"red/images/deploy-nodes-o.png"},flows:{img:"red/images/deploy-flows-o.png"}},g={unknown:!1,unusedConfig:!1,invalid:!1},h="full";return{init:b}}(),RED.menu=function(){function a(b){function e(){var a=c(b.id);a?(j.addClass("active"),b.onselect.call(b,!0)):a===!1?(j.removeClass("active"),b.onselect.call(b,!1)):b.hasOwnProperty("selected")&&(b.selected?j.addClass("active"):j.removeClass("active"),b.onselect.call(b,b.selected))}var g;if(null!==b&&b.id){var h=RED.settings.theme("menu."+b.id);if(h===!1)return null}if(null===b)g=$('<li class="divider"></li>');else{g=$("<li></li>"),b.group&&g.addClass("menu-group-"+b.group);var i="<a "+(b.id?'id="'+b.id+'" ':"")+'tabindex="-1" href="#">';b.toggle&&(i+='<i class="fa fa-square pull-left"></i>',i+='<i class="fa fa-check-square pull-left"></i>'),void 0!==b.icon&&(i+=/\.png/.test(b.icon)?'<img src="'+b.icon+'"/> ':'<i class="'+(b.icon?b.icon:'" style="display: inline-block;"')+'"></i> '),i+=b.sublabel?'<span class="menu-label-container"><span class="menu-label">'+b.label+'</span><span class="menu-sublabel">'+b.sublabel+"</span></span>":'<span class="menu-label">'+b.label+"</span>",i+="</a>";var j=$(i).appendTo(g);if(k[b.id]=b,b.onselect?(j.click(function(){if(!$(this).parent().hasClass("disabled"))if(b.toggle){var a=d(b.id);if("string"==typeof b.toggle){if(!a){for(var c in k)if(k.hasOwnProperty(c)){var e=k[c];e.id!=b.id&&b.toggle==e.toggle&&f(e.id,!1)}f(b.id,!0)}}else f(b.id,!a)}else b.onselect.call(b)}),e()):b.href?j.attr("target","_blank").attr("href",b.href):b.options||(g.addClass("disabled"),j.click(function(a){a.preventDefault()})),b.options){g.addClass("dropdown-submenu pull-left");for(var l=$('<ul id="'+b.id+'-submenu" class="dropdown-menu"></ul>').appendTo(g),m=0;m<b.options.length;m++){var n=a(b.options[m]);n&&n.appendTo(l)}}b.disabled&&g.addClass("disabled")}return g}function b(b){for(var c=$("#"+b.id),d=$("<ul/>",{id:b.id+"-submenu","class":"dropdown-menu pull-right"}).insertAfter(c),e=!1,f=0;f<b.options.length;f++){var g=b.options[f];if(null!==g||!e){var h=a(g);h&&(h.appendTo(d),e=null===g)}}}function c(a){return RED.settings.get("menu-"+a)}function d(a){return $("#"+a).hasClass("active")}function e(a,b){RED.settings.set("menu-"+a,b)}function f(a,b){if(d(a)!=b){var c=k[a];b?$("#"+a).addClass("active"):$("#"+a).removeClass("active"),c&&c.onselect&&c.onselect.call(c,b),e(a,b)}}function g(a,b){b?$("#"+a).parent().addClass("disabled"):$("#"+a).parent().removeClass("disabled")}function h(b,c){var d=a(c);if(c.group){var e=$("#"+b+"-submenu").children(".menu-group-"+c.group);if(0===e.length)d.appendTo("#"+b+"-submenu");else{for(var f=0;f<e.length;f++){var g=e[f],h=$(g).find(".menu-label").html();if(c.label<h){$(g).before(d);break}}f===e.length&&d.appendTo("#"+b+"-submenu")}}else d.appendTo("#"+b+"-submenu")}function i(a){$("#"+a).parent().remove()}function j(a,b){var c=k[a];c&&(c.onselect=b,$("#"+a).click(function(){$(this).parent().hasClass("disabled")||(k[a].toggle?f(a,!d(a)):k[a].onselect.call(k[a]))}))}var k={};return{init:b,setSelected:f,isSelected:d,setDisabled:g,addItem:h,removeItem:i,setAction:j}}(),RED.keyboard=function(){function a(a,b,c,d){var f=b,g=c,h=d;"function"==typeof b&&(f={},g=b,h=c),e[a]={modifiers:f,ondown:g,onup:h}}function b(a){delete e[a]}function c(){RED.settings.theme("menu.menu-item-keyboard-shortcuts",!0)&&(f||(f=$('<div id="keyboard-help-dialog" class="hide"><div style="vertical-align: top;display:inline-block; box-sizing: border-box; width:50%; padding: 10px;"><table class="keyboard-shortcuts"><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">a</span></td><td>'+RED._("keyboard.selectAll")+'</td></tr><tr><td><span class="help-key">Shift</span> + <span class="help-key">Click</span></td><td>'+RED._("keyboard.selectAllConnected")+'</td></tr><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">Click</span></td><td>'+RED._("keyboard.addRemoveNode")+'</td></tr><tr><td><span class="help-key">Delete</span></td><td>'+RED._("keyboard.deleteSelected")+'</td></tr><tr><td>&nbsp;</td><td></td></tr><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">i</span></td><td>'+RED._("keyboard.importNode")+'</td></tr><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">e</span></td><td>'+RED._("keyboard.exportNode")+'</td></tr></table></div><div style="vertical-align: top;display:inline-block; box-sizing: border-box; width:50%; padding: 10px;"><table class="keyboard-shortcuts"><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">Space</span></td><td>'+RED._("keyboard.toggleSidebar")+'</td></tr><tr><td></td><td></td></tr><tr><td><span class="help-key">Delete</span></td><td>'+RED._("keyboard.deleteNode")+'</td></tr><tr><td></td><td></td></tr><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">c</span></td><td>'+RED._("keyboard.copyNode")+'</td></tr><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">x</span></td><td>'+RED._("keyboard.cutNode")+'</td></tr><tr><td><span class="help-key">Ctrl/&#8984;</span> + <span class="help-key">v</span></td><td>'+RED._("keyboard.pasteNode")+"</td></tr></table></div></div>").appendTo("body").dialog({modal:!0,autoOpen:!1,width:"800",title:"Keyboard shortcuts",resizable:!1,open:function(){RED.keyboard.disable()},close:function(){RED.keyboard.enable()}})),f.dialog("open"))}var d=!0,e={};d3.select(window).on("keydown",function(){if(d){var a=e[d3.event.keyCode];a&&a.ondown&&(a.modifiers&&(a.modifiers.shift&&!d3.event.shiftKey||a.modifiers.ctrl&&!d3.event.ctrlKey&&!d3.event.metaKey||a.modifiers.alt&&!d3.event.altKey)||a.ondown())}}),d3.select(window).on("keyup",function(){if(d){var a=e[d3.event.keyCode];a&&a.onup&&(a.modifiers&&(a.modifiers.shift&&!d3.event.shiftKey||a.modifiers.ctrl&&!d3.event.ctrlKey&&!d3.event.metaKey||a.modifiers.alt&&!d3.event.altKey)||a.onup())}});var f=null;return{add:a,remove:b,disable:function(){d=!1},enable:function(){d=!0},showHelp:c}}(),RED.tabs=function(){function a(a){function b(){return d($(this)),!1}function c(){return a.ondblclick&&a.ondblclick(h[$(this).attr("href").slice(1)]),!1}function d(b){"string"==typeof b&&(b=j.find("a[href='#"+b+"']")),b.parent().hasClass("active")||(j.children().removeClass("active"),j.children().css({transition:"width 100ms"}),b.parent().addClass("active"),a.onchange&&a.onchange(h[b.attr("href").slice(1)]),e(),setTimeout(function(){j.children().css({transition:""})},100))}function e(){var b=j.find("li.red-ui-tab"),c=j.width(),d=b.size(),e=(c-12-6*d)/d;g=100*e/c,i=g+"%",a.hasOwnProperty("minimumActiveTabWidth")&&(e<a.minimumActiveTabWidth?(d-=1,e=(c-12-a.minimumActiveTabWidth-6*d)/d,g=100*e/c,i=a.minimumActiveTabWidth+"px"):i=0),b.css({width:g+"%"}),50>e?(j.find(".red-ui-tab-close").hide(),j.find(".red-ui-tab-icon").hide()):(j.find(".red-ui-tab-close").show(),j.find(".red-ui-tab-icon").show()),0!==i&&(j.find("li.red-ui-tab.active").css({width:a.minimumActiveTabWidth}),j.find("li.red-ui-tab.active .red-ui-tab-close").show(),j.find("li.red-ui-tab.active .red-ui-tab-icon").show())}function f(b){var c=j.find("a[href='#"+b+"']").parent();if(c.hasClass("active")){var f=c.prev();0===f.size()&&(f=c.next()),d(f.find("a"))}c.remove(),a.onremove&&a.onremove(h[b]),delete h[b],e()}var g,h={},i=0,j=$("#"+a.id);return j.addClass("red-ui-tabs"),j.children().first().addClass("active"),j.children().addClass("red-ui-tab"),j.find("li.red-ui-tab a").on("click",b).on("dblclick",c),e(),{addTab:function(g){h[g.id]=g;var i=$("<li/>",{"class":"red-ui-tab"}).appendTo(j),k=$("<a/>",{href:"#"+g.id,"class":"red-ui-tab-label"}).appendTo(i);if(g.icon&&$('<img src="'+g.icon+'" class="red-ui-tab-icon"/>').appendTo(k),$("<span/>").text(g.label).appendTo(k),k.on("click",b),k.on("dblclick",c),g.closeable){var l=$("<a/>",{href:"#","class":"red-ui-tab-close"}).appendTo(i);l.append('<i class="fa fa-times" />'),l.on("click",function(a){f(g.id)})}e(),a.onadd&&a.onadd(g),k.attr("title",g.label),1==j.find("li.red-ui-tab").size()&&d(k)},removeTab:f,activateTab:d,resize:e,count:function(){return j.find("li.red-ui-tab").size()},contains:function(a){return j.find("a[href='#"+a+"']").length>0},renameTab:function(a,b){h[a].label=b;var c=j.find("a[href='#"+a+"']");c.attr("title",b),c.find("span").text(b),e()}}}return{create:a}}(),RED.popover=function(){function a(a){var b,c,d=a.target,e=a.content,f=a.delay,g=null,h=function(){if(b){c=$('<div class="red-ui-popover"></div>').html(e).appendTo("body");var a=d.offset(),f=d.width(),g=d.height(),h=c.height();c.css({top:a.top+g/2-h/2-10,left:a.left+f+17}),c.fadeIn("fast")}},i=function(){b||c&&(c.fadeOut("fast",function(){$(this).remove()}),c=null)};d.on("mouseenter",function(a){clearTimeout(g),b=!0,g=setTimeout(h,f.show)}),d.on("mouseleave",function(a){g&&clearTimeout(g),b=!1,setTimeout(i,f.hide)});var j={setContent:function(a){e=a}};return d.data("popover",j),j}return{create:a}}(),RED.workspaces=function(){function a(a){if(a)g.addTab(a),g.resize();else{var b=RED.nodes.id();do i+=1;while(0!==$("#workspace-tabs a[title='"+RED._("workspace.defaultName",{number:i})+"']").size());a={type:"tab",id:b,label:RED._("workspace.defaultName",{number:i})},RED.nodes.addWorkspace(a),g.addTab(a),g.activateTab(b),RED.history.push({t:"add",workspaces:[a],dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0)}}function b(a,b){if(1!=g.count()){var c=[];if(b||(c=RED.nodes.filterNodes({z:a.id})),b||0===c.length){f(a);var d=RED.nodes.removeWorkspace(a.id);d.t="delete",d.dirty=RED.nodes.dirty(),d.workspaces=[a],RED.history.push(d),RED.nodes.dirty(!0)}else $("#node-dialog-delete-workspace").dialog("option","workspace",a),$("#node-dialog-delete-workspace-content").text(RED._("workspace.delete",{label:a.label})),$("#node-dialog-delete-workspace").dialog("open")}}function c(a){var b=RED.nodes.workspace(a);$("#node-dialog-rename-workspace").dialog("option","workspace",b),1==g.count()?$("#node-dialog-rename-workspace").next().find(".leftButton").prop("disabled",!0).addClass("ui-state-disabled"):$("#node-dialog-rename-workspace").next().find(".leftButton").prop("disabled",!1).removeClass("ui-state-disabled"),$("#node-input-workspace-name").val(b.label),$("#node-dialog-rename-workspace").dialog("open")}function d(){g=RED.tabs.create({id:"workspace-tabs",onchange:function(a){var b={old:h};h=a.id,b.workspace=h,RED.events.emit("workspace:change",b),RED.sidebar.config.refresh()},ondblclick:function(a){"subflow"!=a.type?c(a.id):RED.editor.editSubflow(RED.nodes.subflow(a.id))},onadd:function(a){RED.menu.addItem("menu-item-workspace",{id:"menu-item-workspace-menu-"+a.id.replace(".","-"),label:a.label,onselect:function(){g.activateTab(a.id)}}),RED.menu.setDisabled("menu-item-workspace-delete",1==g.count())},onremove:function(a){RED.menu.setDisabled("menu-item-workspace-delete",1==g.count()),RED.menu.removeItem("menu-item-workspace-menu-"+a.id.replace(".","-"))},minimumActiveTabWidth:150}),$("#node-dialog-rename-workspace form").submit(function(a){a.preventDefault()}),$("#node-dialog-rename-workspace").dialog({modal:!0,autoOpen:!1,width:500,title:RED._("workspace.renameSheet"),buttons:[{"class":"leftButton",text:RED._("common.label.delete"),click:function(){var a=$(this).dialog("option","workspace");$(this).dialog("close"),b(a)}},{text:RED._("common.label.ok"),click:function(){var a=$(this).dialog("option","workspace"),b=$("#node-input-workspace-name").val();a.label!=b&&(g.renameTab(a.id,b),RED.nodes.dirty(!0),$("#menu-item-workspace-menu-"+a.id.replace(".","-")).text(b)),$(this).dialog("close")}},{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}}],open:function(a){RED.keyboard.disable()},close:function(a){RED.keyboard.enable()}}),$("#node-dialog-delete-workspace").dialog({modal:!0,autoOpen:!1,width:500,title:RED._("workspace.confirmDelete"),buttons:[{text:RED._("common.label.ok"),click:function(){var a=$(this).dialog("option","workspace");b(a,!0),$(this).dialog("close")}},{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}}],open:function(a){RED.keyboard.disable()},close:function(a){RED.keyboard.enable()}})}function e(){d(),$("#btn-workspace-add-tab").on("click",function(b){a(),b.preventDefault()}),RED.events.on("sidebar:resize",g.resize),RED.menu.setAction("menu-item-workspace-delete",function(){b(RED.nodes.workspace(h))}),$(window).resize(function(){g.resize()})}function f(a){a?g.contains(a.id)&&g.removeTab(a.id):b(RED.nodes.workspace(h))}var g,h=0,i=0;return{init:e,add:a,remove:f,edit:function(a){c(a||h)},contains:function(a){return g.contains(a)},count:function(){return g.count()},active:function(){return h},show:function(b){if(!g.contains(b)){var c=RED.nodes.subflow(b);c&&a({type:"subflow",id:b,icon:"red/images/subflow_tab.png",label:c.name,closeable:!0})}g.activateTab(b)},refresh:function(){RED.nodes.eachSubflow(function(a){g.contains(a.id)&&g.renameTab(a.id,a.name)}),RED.sidebar.config.refresh()},resize:function(){g.resize()}}}(),RED.view=function(){function a(){var a=RED.workspaces.active();N=RED.nodes.filterNodes({z:a}),O=RED.nodes.filterLinks({source:{z:a},target:{z:a}})}function b(){RED.events.on("workspace:change",function(b){var c=$("#chart");0!==b.old&&(L[b.old]={left:c.scrollLeft(),top:c.scrollTop()});var d=c.scrollLeft(),e=c.scrollTop();M=RED.nodes.subflow(b.workspace),RED.menu.setDisabled("menu-item-workspace-edit",M),RED.menu.setDisabled("menu-item-workspace-delete",1==RED.workspaces.count()||M),L[b.workspace]?(c.scrollLeft(L[b.workspace].left),c.scrollTop(L[b.workspace].top)):(c.scrollLeft(0),c.scrollTop(0));var f=c.scrollLeft()-d,g=c.scrollTop()-e;null!=W&&(W[0]+=f,W[1]+=g),j(),RED.nodes.eachNode(function(a){a.dirty=!0}),k(),a(),x()}),$("#btn-zoom-out").click(function(){g()}),$("#btn-zoom-zero").click(function(){h()}),$("#btn-zoom-in").click(function(){f()}),$("#chart").on("DOMMouseScroll mousewheel",function(a){if(a.altKey){a.preventDefault(),a.stopPropagation();var b=-a.originalEvent.detail||a.originalEvent.wheelDelta;0>=b?g():f()}}),$("#chart").droppable({accept:".palette_node",drop:function(b,c){d3.event=b;var d=c.draggable[0].type,e=/^subflow:(.+)$/.exec(d);if(M&&e){var f=e[1];if(f===M.id)return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddSubflowToItself")}),"error");if(RED.nodes.subflowContains(e[1],M.id))return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddCircularReference")}),"error")}var g=d3.touches(this)[0]||d3.mouse(this);g[1]+=this.scrollTop,g[0]+=this.scrollLeft,g[1]/=D,g[0]/=D;var h={id:(1+4294967295*Math.random()).toString(16),x:g[0],y:g[1],w:E,z:RED.workspaces.active()};if(h.type=d,h._def=RED.nodes.getType(h.type),e){var i=RED.nodes.subflow(e[1]);h.inputs=i["in"].length,h.outputs=i.out.length}else{h.inputs=h._def.inputs||0,h.outputs=h._def.outputs;for(var l in h._def.defaults)h._def.defaults.hasOwnProperty(l)&&(h[l]=h._def.defaults[l].value);h._def.onadd&&h._def.onadd.call(h)}h.changed=!0,h.h=Math.max(F,15*(h.outputs||0));var m={t:"add",nodes:[h.id],dirty:RED.nodes.dirty()};if(M){var n=RED.subflow.refresh(!0);n&&(m.subflow={id:M.id,changed:M.changed,instances:n.instances})}RED.history.push(m),RED.nodes.add(h),RED.editor.validateNode(h),RED.nodes.dirty(!0),j(),h.selected=!0,Y.push({n:h}),a(),k(),x(),h._def.autoedit&&RED.editor.edit(h)}}),RED.keyboard.add(90,{ctrl:!0},function(){RED.history.pop()}),RED.keyboard.add(65,{ctrl:!0},function(){i(),d3.event.preventDefault()}),RED.keyboard.add(187,{ctrl:!0},function(){f(),d3.event.preventDefault()}),RED.keyboard.add(189,{ctrl:!0},function(){g(),d3.event.preventDefault()}),RED.keyboard.add(48,{ctrl:!0},function(){h(),d3.event.preventDefault()}),RED.keyboard.add(86,{ctrl:!0},function(){z(ea),d3.event.preventDefault()})}function c(){if(R||Q||(P=null,k()),0===X&&(Z&&(Z.remove(),Z=null),!K)){var a=d3.mouse(this);Z=ha.append("rect").attr("ox",a[0]).attr("oy",a[1]).attr("rx",1).attr("ry",1).attr("x",a[0]).attr("y",a[1]).attr("width",0).attr("height",0).attr("class","lasso"),d3.event.preventDefault()}}function d(){if(W=d3.touches(this)[0]||d3.mouse(this),Z){var a,b,c=parseInt(Z.attr("ox")),d=parseInt(Z.attr("oy")),e=parseInt(Z.attr("x")),f=parseInt(Z.attr("y"));return W[0]<c?(e=W[0],a=c-e):a=W[0]-e,W[1]<d?(f=W[1],b=d-f):b=W[1]-f,void Z.attr("x",e).attr("y",f).attr("width",a).attr("height",b)}if(X==RED.state.IMPORT_DRAGGING||R||null!=P){var g;if(X==RED.state.JOINING){ja.attr("class","drag_line"),g=W;var h=0===S?R.outputs||1:1,i=T,j=13*-((h-1)/2)+13*i,k=0===S?1:-1,l=g[1]-(R.y+j),m=g[0]-(R.x+k*R.w/2),n=Math.sqrt(l*l+m*m),o=C,p=0;E>n&&(o=.75-.75*((E-n)/E)),0>m*k&&(o+=2*(Math.min(5*E,Math.abs(m))/(5*E)),Math.abs(l)<3*F&&(p=(l>0?.5:-.5)*((3*F-Math.abs(l))/(3*F))*(Math.min(E,Math.abs(m))/E))),ja.attr("d","M "+(R.x+k*R.w/2)+" "+(R.y+j)+" C "+(R.x+k*(R.w/2+E*o))+" "+(R.y+j+p*F)+" "+(g[0]-k*o*E)+" "+(g[1]-p*F)+" "+g[0]+" "+g[1]),d3.event.preventDefault()}else if(X==RED.state.MOVING){g=d3.mouse(document.body),isNaN(g[0])&&(g=d3.touches(document.body)[0]);var q=(V[0]-g[0])*(V[0]-g[0])+(V[1]-g[1])*(V[1]-g[1]);q>3&&(X=RED.state.MOVING_ACTIVE,da=0)}else if(X==RED.state.MOVING_ACTIVE||X==RED.state.IMPORT_DRAGGING){g=W;for(var r,s,t=0,u=0,v=0;v<Y.length;v++)r=Y[v],d3.event.shiftKey&&(r.n.ox=r.n.x,r.n.oy=r.n.y),r.n.x=g[0]+r.dx,r.n.y=g[1]+r.dy,r.n.dirty=!0,t=Math.min(r.n.x-r.n.w/2-5,t),u=Math.min(r.n.y-r.n.h/2-5,u);if(0!==t||0!==u)for(s=0;s<Y.length;s++)r=Y[s],r.n.x-=t,r.n.y-=u;if(d3.event.shiftKey&&Y.length>0){var w=[0,0];if(r=Y[0],w[0]=r.n.x-(20*Math.floor((r.n.x-r.n.w/2)/20)+r.n.w/2),w[1]=r.n.y-20*Math.floor(r.n.y/20),0!==w[0]||0!==w[1])for(s=0;s<Y.length;s++)r=Y[s],r.n.x-=w[0],r.n.y-=w[1],r.n.x==r.n.ox&&r.n.y==r.n.oy&&(r.dirty=!1)}}0!==X&&x()}}function e(){if(R&&X==RED.state.JOINING&&ja.attr("class","drag_line_hidden"),Z){var b=parseInt(Z.attr("x")),c=parseInt(Z.attr("y")),d=b+parseInt(Z.attr("width")),e=c+parseInt(Z.attr("height"));d3.event.ctrlKey||j(),RED.nodes.eachNode(function(a){a.z!=RED.workspaces.active()||a.selected||(a.selected=a.x>b&&a.x<d&&a.y>c&&a.y<e,a.selected&&(a.dirty=!0,Y.push({n:a})))}),M&&(M["in"].forEach(function(a){a.selected=a.x>b&&a.x<d&&a.y>c&&a.y<e,a.selected&&(a.dirty=!0,Y.push({n:a}))}),M.out.forEach(function(a){a.selected=a.x>b&&a.x<d&&a.y>c&&a.y<e,a.selected&&(a.dirty=!0,Y.push({n:a}))})),k(),Z.remove(),Z=null}else X!=RED.state.DEFAULT||null!=Q||d3.event.ctrlKey||(j(),k());if(X==RED.state.MOVING_ACTIVE&&Y.length>0){for(var f=[],g=0;g<Y.length;g++)f.push({n:Y[g].n,ox:Y[g].ox,oy:Y[g].oy});RED.history.push({t:"move",nodes:f,dirty:RED.nodes.dirty()})}if(X==RED.state.MOVING||X==RED.state.MOVING_ACTIVE)for(var h=0;h<Y.length;h++)delete Y[h].ox,delete Y[h].oy;X==RED.state.IMPORT_DRAGGING&&(RED.keyboard.remove(27),a(),RED.nodes.dirty(!0)),q(),x()}function f(){2>D&&(D+=.1,x())}function g(){D>.3&&(D-=.1,x())}function h(){D=1,x()}function i(){RED.nodes.eachNode(function(a){a.z==RED.workspaces.active()&&(a.selected||(a.selected=!0,a.dirty=!0,Y.push({n:a})))}),M&&(M["in"].forEach(function(a){a.selected||(a.selected=!0,a.dirty=!0,Y.push({n:a}))}),M.out.forEach(function(a){a.selected||(a.selected=!0,a.dirty=!0,Y.push({n:a}))})),P=null,k(),x()}function j(){for(var a=0;a<Y.length;a++){var b=Y[a];b.n.dirty=!0,b.n.selected=!1}Y=[],P=null}function k(){0===Y.length&&null==P?(RED.keyboard.remove(8),RED.keyboard.remove(46),RED.keyboard.remove(67),RED.keyboard.remove(88)):(RED.keyboard.add(8,function(){n(),d3.event.preventDefault()}),RED.keyboard.add(46,function(){n(),d3.event.preventDefault()}),RED.keyboard.add(67,{ctrl:!0},function(){o(),d3.event.preventDefault()}),RED.keyboard.add(88,{ctrl:!0},function(){o(),n(),d3.event.preventDefault()})),0===Y.length?(RED.keyboard.remove(38),RED.keyboard.remove(40),RED.keyboard.remove(37),RED.keyboard.remove(39)):(RED.keyboard.add(38,function(){d3.event.shiftKey?m(0,-20):m(0,-1),d3.event.preventDefault()},l),RED.keyboard.add(40,function(){d3.event.shiftKey?m(0,20):m(0,1),d3.event.preventDefault()},l),RED.keyboard.add(37,function(){d3.event.shiftKey?m(-20,0):m(-1,0),d3.event.preventDefault()},l),RED.keyboard.add(39,function(){d3.event.shiftKey?m(20,0):m(1,0),d3.event.preventDefault()},l));var a={};Y.length>0&&(a.nodes=Y.map(function(a){return a.n})),null!=P&&(a.link=P),RED.events.emit("view:selection-changed",a)}function l(){for(var a=[],b=0;b<Y.length;b++)a.push({n:Y[b].n,ox:Y[b].ox,oy:Y[b].oy}),delete Y[b].ox,delete Y[b].oy;RED.history.push({t:"move",nodes:a,dirty:RED.nodes.dirty()})}function m(a,b){for(var c,d=0,e=0,f=0;f<Y.length;f++)c=Y[f],null==c.ox&&null==c.oy&&(c.ox=c.n.x,c.oy=c.n.y),c.n.x+=a,c.n.y+=b,c.n.dirty=!0,d=Math.min(c.n.x-c.n.w/2-5,d),e=Math.min(c.n.y-c.n.h/2-5,e);if(0!==d||0!==e)for(var g=0;g<Y.length;g++)c=Y[g],c.n.x-=d,c.n.y-=e;x()}function n(){var b,c=[],d=[],e=[],f=[],g=[],h=RED.nodes.dirty();if(Y.length>0){for(var i=0;i<Y.length;i++){var j=Y[i].n;if(j.selected=!1,"subflow"!=j.type){j.x<0&&(j.x=25);var l=RED.nodes.remove(j.id);c.push(j),c=c.concat(l.nodes),d=d.concat(l.links)}else"out"===j.direction?e.push(j):"in"===j.direction&&f.push(j),j.dirty=!0}e.length>0&&(b=RED.subflow.removeOutput(e),b&&(d=d.concat(b.links))),1==f.length&&(b=RED.subflow.removeInput(),b&&(d=d.concat(b.links)));var m=RED.subflow.refresh(!0);m&&(g=m.instances),Y=[],(c.length>0||e.length>0||f.length>0)&&RED.nodes.dirty(!0)}P&&(RED.nodes.removeLink(P),d.push(P),RED.nodes.dirty(!0));var n={t:"delete",nodes:c,links:d,subflowOutputs:e,subflowInputs:f,subflow:{instances:g},dirty:h};RED.history.push(n),P=null,a(),k(),x()}function o(){if(Y.length>0){for(var a=[],b=0;b<Y.length;b++){var c=Y[b].n;if("subflow"!=c.type){for(var d in c._def.defaults)if(c._def.defaults.hasOwnProperty(d)&&c._def.defaults[d].type){var e=RED.nodes.node(c[d]);e&&e._def.exclusive&&a.push(RED.nodes.convertNode(e))}a.push(RED.nodes.convertNode(c))}}ea=JSON.stringify(a),RED.notify(RED._("clipboard.nodeCopied",{count:a.length}))}}function p(a,b,c){var d=document.createElement("span");d.className=b,d.style.position="absolute",d.style.top="-1000px",d.innerHTML=(a||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),document.body.appendChild(d);var e=d.offsetWidth;return document.body.removeChild(d),c+e}function q(){R=null,U=null,Q=null,X=0,S=0}function r(a,b,c){R=a,P=null,X=RED.state.JOINING,S=b,T=c||0,document.body.style.cursor="crosshair",d3.event.preventDefault()}function s(b,c,d){if(document.body.style.cursor="",X==RED.state.JOINING&&R){if("undefined"!=typeof TouchEvent&&d3.event instanceof TouchEvent?RED.nodes.eachNode(function(a){if(a.z==RED.workspaces.active()){var b=a.w/2,e=a.h/2;a.x-b<W[0]&&a.x+b>W[0]&&a.y-e<W[1]&&a.y+e>W[1]&&(U=a,c=U.inputs>0?1:0,d=0)}}):U=b,c==S||U===R)return ja.attr("class","drag_line_hidden"),void q();var e,f,g;0===S?(e=R,g=T,f=U):1==S&&(e=U,f=R,g=d);var h=0!==RED.nodes.filterLinks({source:e,target:f,sourcePort:g}).length;if(!h){var i={source:e,sourcePort:g,target:f};RED.nodes.addLink(i);var j={t:"add",links:[i],dirty:RED.nodes.dirty()};if(M){var k=RED.subflow.refresh(!0);k&&(j.subflow={id:M.id,changed:M.changed,instances:k.instances})}RED.history.push(j),a(),RED.nodes.dirty(!0)}P=null,x()}}function t(a){if(ba&&R==a&&da>0&&750>da)return X=RED.state.DEFAULT,"subflow"!=a.type?RED.editor.edit(a):RED.editor.editSubflow(M),da=0,void d3.event.stopPropagation();var b=a._def?a.inputs>0?1:0:"in"==a.direction?0:1;s(a,b,0)}function u(a){if(y(),X==RED.state.IMPORT_DRAGGING)return RED.keyboard.remove(27),k(),RED.nodes.dirty(!0),x(),q(),void d3.event.stopPropagation();R=a;var b=Date.now();da=b-ca,ca=b,ba=aa==R,aa=R;var c;if(a.selected&&d3.event.ctrlKey){for(a.selected=!1,c=0;c<Y.length;c+=1)if(Y[c].n===a){Y.splice(c,1);break}}else{if(d3.event.shiftKey){j();for(var d=RED.nodes.getAllFlowNodes(R),e=0;e<d.length;e++)d[e].selected=!0,d[e].dirty=!0,Y.push({n:d[e]})}else a.selected||(d3.event.ctrlKey||j(),R.selected=!0,Y.push({n:R}));if(P=null,2!=d3.event.button){X=RED.state.MOVING;var f=d3.touches(this)[0]||d3.mouse(this);for(f[0]+=a.x-a.w/2,f[1]+=a.y-a.h/2,c=0;c<Y.length;c++)Y[c].ox=Y[c].n.x,Y[c].oy=Y[c].n.y,Y[c].dx=Y[c].n.x-f[0],Y[c].dy=Y[c].n.y-f[1];V=d3.mouse(document.body),isNaN(V[0])&&(V=d3.touches(document.body)[0])}}a.dirty=!0,k(),x(),d3.event.stopPropagation()}function v(a){M||a.changed?a.changed?RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.undeployedChanges")}),"warning"):RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabled")}),"warning"):(a._def.button.toggle&&(a[a._def.button.toggle]=!a[a._def.button.toggle],a.dirty=!0),a._def.button.onclick&&a._def.button.onclick.call(a),a.dirty&&x()),d3.event.preventDefault()}function w(a,b){var c=R,d=[];d.push({name:"delete",disabled:0===Y.length&&null===P,onselect:function(){n()}}),d.push({name:"cut",disabled:0===Y.length,onselect:function(){o(),n()}}),d.push({name:"copy",disabled:0===Y.length,onselect:function(){o()}}),d.push({name:"paste",disabled:0===ea.length,onselect:function(){z(ea,!0)}}),d.push({name:"edit",disabled:1!=Y.length,onselect:function(){RED.editor.edit(c)}}),d.push({name:"select",onselect:function(){i()}}),d.push({name:"undo",disabled:0===RED.history.depth(),onselect:function(){RED.history.pop()}}),RED.touch.radialMenu.show(a,b,d),q()}function x(){if(ha.attr("transform","scale("+D+")"),ga.attr("width",A*D).attr("height",B*D),X!=RED.state.JOINING){var a={};if(M){var b=ha.selectAll(".subflowoutput").data(M.out,function(a,b){return a.id});b.exit().remove();var c=b.enter().insert("svg:g").attr("class","node subflowoutput").attr("transform",function(a){return"translate("+(a.x-20)+","+(a.y-20)+")"});c.each(function(a,b){a.w=40,a.h=40}),c.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",t).on("mousedown",u).on("touchstart",function(a){var b=d3.select(this),c=d3.event.touches.item(0),d=[c.pageX,c.pageY];I=[c.pageX,c.pageY],H=0,K=setTimeout(function(){w(b,d)},G),u.call(this,a)}).on("touchend",function(a){return clearTimeout(K),K=null,RED.touch.radialMenu.active()?void d3.event.stopPropagation():void t.call(this,a)}),c.append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).attr("x",-5).attr("y",15).on("mousedown",function(a,b){r(a,1,0)}).on("touchstart",function(a,b){r(a,1,0)}).on("mouseup",function(a,b){s(a,1,0)}).on("touchend",function(a,b){s(a,1,0)}).on("mouseover",function(a,b){var c=d3.select(this);c.classed("port_hovered",X!=RED.state.JOINING||0!==S)}).on("mouseout",function(a,b){var c=d3.select(this);c.classed("port_hovered",!1)}),c.append("svg:text").attr("class","port_label").attr("x",20).attr("y",8).style("font-size","10px").text("output"),c.append("svg:text").attr("class","port_label port_index").attr("x",20).attr("y",24).text(function(a,b){return b+1});var d=ha.selectAll(".subflowinput").data(M["in"],function(a,b){return a.id});d.exit().remove();var e=d.enter().insert("svg:g").attr("class","node subflowinput").attr("transform",function(a){return"translate("+(a.x-20)+","+(a.y-20)+")"});e.each(function(a,b){a.w=40,a.h=40}),e.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",t).on("mousedown",u).on("touchstart",function(a){var b=d3.select(this),c=d3.event.touches.item(0),d=[c.pageX,c.pageY];I=[c.pageX,c.pageY],H=0,K=setTimeout(function(){w(b,d)},G),u.call(this,a)}).on("touchend",function(a){return clearTimeout(K),K=null,RED.touch.radialMenu.active()?void d3.event.stopPropagation():void t.call(this,a)}),e.append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).attr("x",35).attr("y",15).on("mousedown",function(a,b){r(a,0,b)}).on("touchstart",function(a,b){r(a,0,b)}).on("mouseup",function(a,b){s(a,0,b)}).on("touchend",function(a,b){s(a,0,b)}).on("mouseover",function(a,b){var c=d3.select(this);c.classed("port_hovered",X!=RED.state.JOINING||0!==S)}).on("mouseout",function(a,b){var c=d3.select(this);c.classed("port_hovered",!1)}),e.append("svg:text").attr("class","port_label").attr("x",18).attr("y",20).style("font-size","10px").text("input"),b.each(function(b,c){if(b.dirty){var d=d3.select(this);d.selectAll(".subflowport").classed("node_selected",function(a){return a.selected}),d.selectAll(".port_index").text(function(a){return a.i+1}),d.attr("transform",function(a){return"translate("+(a.x-a.w/2)+","+(a.y-a.h/2)+")"}),a[b.id]=b,b.dirty=!1}}),d.each(function(b,c){if(b.dirty){var d=d3.select(this);d.selectAll(".subflowport").classed("node_selected",function(a){return a.selected}),d.attr("transform",function(a){return"translate("+(a.x-a.w/2)+","+(a.y-a.h/2)+")"}),a[b.id]=b,b.dirty=!1}})}else ha.selectAll(".subflowoutput").remove(),ha.selectAll(".subflowinput").remove();var f=ha.selectAll(".nodegroup").data(N,function(a){return a.id});f.exit().remove();var g=f.enter().insert("svg:g").attr("class","node nodegroup");g.each(function(a,b){var c=d3.select(this);c.attr("id",a.id);var d=a._def.label;if(d=("function"==typeof d?d.call(a):d)||"",a.w=Math.max(E,p(d,"node_label",50)+(a._def.inputs>0?7:0)),a.h=Math.max(F,15*(a.outputs||0)),a._def.badge){var e=c.append("svg:g").attr("class","node_badge_group"),f=e.append("rect").attr("class","node_badge").attr("rx",5).attr("ry",5).attr("width",40).attr("height",15);
e.append("svg:text").attr("class","node_badge_label").attr("x",35).attr("y",11).attr("text-anchor","end").text(a._def.badge()),a._def.onbadgeclick&&f.attr("cursor","pointer").on("click",function(a){a._def.onbadgeclick.call(a),d3.event.preventDefault()})}if(a._def.button){var g=c.append("svg:g").attr("transform",function(a){return"translate("+("right"==a._def.align?94:-25)+",2)"}).attr("class",function(a){return"node_button "+("right"==a._def.align?"node_right_button":"node_left_button")});g.append("rect").attr("rx",5).attr("ry",5).attr("width",32).attr("height",F-4).attr("fill","#eee"),g.append("rect").attr("class","node_button_button").attr("x",function(a){return"right"==a._def.align?11:5}).attr("y",4).attr("rx",4).attr("ry",4).attr("width",16).attr("height",F-12).attr("fill",function(a){return a._def.color}).attr("cursor","pointer").on("mousedown",function(a){Z||a.changed||(y(),d3.select(this).attr("fill-opacity",.2),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseup",function(a){Z||a.changed||(d3.select(this).attr("fill-opacity",.4),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseover",function(a){Z||a.changed||d3.select(this).attr("fill-opacity",.4)}).on("mouseout",function(a){if(!Z&&!a.changed){var b=1;a._def.button.toggle&&(b=a[a._def.button.toggle]?1:.2),d3.select(this).attr("fill-opacity",b)}}).on("click",v).on("touchstart",v)}c.append("rect").attr("class","node").classed("node_unknown",function(a){return"unknown"==a.type}).attr("rx",5).attr("ry",5).attr("fill",function(a){return a._def.color}).on("mouseup",t).on("mousedown",u).on("touchstart",function(a){var b=d3.select(this),c=d3.event.touches.item(0),d=[c.pageX,c.pageY];I=[c.pageX,c.pageY],H=0,K=setTimeout(function(){w(b,d)},G),u.call(this,a)}).on("touchend",function(a){return clearTimeout(K),K=null,RED.touch.radialMenu.active()?void d3.event.stopPropagation():void t.call(this,a)}).on("mouseover",function(a){if(0===X){var b=d3.select(this);b.classed("node_hovered",!0)}}).on("mouseout",function(a){var b=d3.select(this);b.classed("node_hovered",!1)});if(a._def.icon){var h=c.append("g").attr("class","node_icon_group").attr("x",0).attr("y",0),i=(h.append("rect").attr("x",0).attr("y",0).attr("class","node_icon_shade").attr("width","30").attr("stroke","none").attr("fill","#000").attr("fill-opacity","0.05").attr("height",function(a){return Math.min(50,a.h-4)}),h.append("image").attr("xlink:href","icons/"+a._def.icon).attr("class","node_icon").attr("x",0).attr("width","30").attr("height","30")),j=h.append("path").attr("d",function(a){return"M 30 1 l 0 "+(a.h-2)}).attr("class","node_icon_shade_border").attr("stroke-opacity","0.1").attr("stroke","#000").attr("stroke-width","1");"right"==a._def.align&&(h.attr("class","node_icon_group node_icon_group_"+a._def.align),j.attr("d",function(a){return"M 0 1 l 0 "+(a.h-2)}));var k=new Image;k.src="icons/"+a._def.icon,k.onload=function(){i.attr("width",Math.min(k.width,30)),i.attr("height",Math.min(k.height,30)),i.attr("x",15-Math.min(k.width,30)/2)},h.style("pointer-events","none")}var l=c.append("svg:text").attr("class","node_label").attr("x",38).attr("dy",".35em").attr("text-anchor","start");a._def.align&&(l.attr("class","node_label node_label_"+a._def.align),"right"===a._def.align&&l.attr("text-anchor","end"));var m=c.append("svg:g").attr("class","node_status_group").style("display","none");m.append("rect").attr("class","node_status").attr("x",6).attr("y",1).attr("width",9).attr("height",9).attr("rx",2).attr("ry",2).attr("stroke-width","3"),m.append("svg:text").attr("class","node_status_label").attr("x",20).attr("y",9);c.append("image").attr("class","node_error hidden").attr("xlink:href","icons/node-error.png").attr("x",0).attr("y",-6).attr("width",10).attr("height",9),c.append("image").attr("class","node_changed hidden").attr("xlink:href","icons/node-changed.png").attr("x",12).attr("y",-6).attr("width",10).attr("height",10)}),f.each(function(b,c){if(b.dirty){if(a[b.id]=b,b.resize){var d=b._def.label;d=("function"==typeof d?d.call(b):d)||"",b.w=Math.max(E,p(d,"node_label",50)+(b._def.inputs>0?7:0)),b.h=Math.max(F,15*(b.outputs||0)),b.resize=!1}var e=d3.select(this);if(e.attr("transform",function(a){return"translate("+(a.x-a.w/2)+","+(a.y-a.h/2)+")"}),X!=RED.state.MOVING_ACTIVE){e.selectAll(".node").attr("width",function(a){return a.w}).attr("height",function(a){return a.h}).classed("node_selected",function(a){return a.selected}).classed("node_highlighted",function(a){return a.highlighted}),e.selectAll(".node_icon_group_right").attr("transform",function(a){return"translate("+(a.w-30)+",0)"}),e.selectAll(".node_label_right").attr("x",function(a){return a.w-38});var f=e.selectAll(".port_input");if(0!==b.inputs||f.empty()){if(1===b.inputs&&f.empty()){var g=e.append("g").attr("class","port_input");g.append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(a){r(a,1,0)}).on("touchstart",function(a){r(a,1,0)}).on("mouseup",function(a){s(a,1,0)}).on("touchend",function(a){s(a,1,0)}).on("mouseover",function(a){var b=d3.select(this);b.classed("port_hovered",X!=RED.state.JOINING||1!=S)}).on("mouseout",function(a){var b=d3.select(this);b.classed("port_hovered",!1)})}}else f.remove();var h=b.outputs,i=b.h/2-(h-1)/2*13;b.ports=b.ports||d3.range(h),b._ports=e.selectAll(".port_output").data(b.ports);var j=b._ports.enter().append("g").attr("class","port_output");if(j.append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(){var a=b;return function(b,c){r(a,0,c)}}()).on("touchstart",function(){var a=b;return function(b,c){r(a,0,c)}}()).on("mouseup",function(){var a=b;return function(b,c){s(a,0,c)}}()).on("touchend",function(){var a=b;return function(b,c){s(a,0,c)}}()).on("mouseover",function(a,b){var c=d3.select(this);c.classed("port_hovered",X!=RED.state.JOINING||0!==S)}).on("mouseout",function(a,b){var c=d3.select(this);c.classed("port_hovered",!1)}),b._ports.exit().remove(),b._ports){h=b.outputs||1,i=b.h/2-(h-1)/2*13;var k=b.w-5;b._ports.each(function(a,b){var c=d3.select(this);c.attr("transform",function(a){return"translate("+k+","+(i+13*b-5)+")"})})}if(e.selectAll("text.node_label").text(function(a,b){return a._def.label?"function"==typeof a._def.label?a._def.label.call(a):a._def.label:""}).attr("y",function(a){return a.h/2-1}).attr("class",function(a){return"node_label"+(a._def.align?" node_label_"+a._def.align:"")+(a._def.labelStyle?" "+("function"==typeof a._def.labelStyle?a._def.labelStyle.call(a):a._def.labelStyle):"")}),b._def.icon){icon=e.select(".node_icon");var l,m=icon.attr("xlink:href");if(l="function"==typeof b._def.icon?b._def.icon.call(b):b._def.icon,"icons/"+l!=m){icon.attr("xlink:href","icons/"+l);var n=new Image;n.src="icons/"+b._def.icon,n.onload=function(){icon.attr("width",Math.min(n.width,30)),icon.attr("height",Math.min(n.height,30)),icon.attr("x",15-Math.min(n.width,30)/2)}}}e.selectAll(".node_tools").attr("x",function(a){return a.w-35}).attr("y",function(a){return a.h-20}),e.selectAll(".node_changed").attr("x",function(a){return a.w-10}).classed("hidden",function(a){return!a.changed}),e.selectAll(".node_error").attr("x",function(a){return a.w-10-(a.changed?13:0)}).classed("hidden",function(a){return a.valid}),e.selectAll(".port_input").each(function(a,b){var c=d3.select(this);c.attr("transform",function(a){return"translate(-5,"+(a.h/2-5)+")"})}),e.selectAll(".node_icon").attr("y",function(a){return(a.h-d3.select(this).attr("height"))/2}),e.selectAll(".node_icon_shade").attr("height",function(a){return a.h}),e.selectAll(".node_icon_shade_border").attr("d",function(a){return"M "+("right"==a._def.align?0:30)+" 1 l 0 "+(a.h-2)}),e.selectAll(".node_button").attr("opacity",function(a){return M||a.changed?.4:1}),e.selectAll(".node_button_button").attr("cursor",function(a){return M||a.changed?"":"pointer"}),e.selectAll(".node_right_button").attr("transform",function(a){var b=a.w-6;return a._def.button.toggle&&!a[a._def.button.toggle]&&(b-=8),"translate("+b+",2)"}),e.selectAll(".node_right_button rect").attr("fill-opacity",function(a){return a._def.button.toggle?a[a._def.button.toggle]?1:.2:1}),e.selectAll(".node_badge_group").attr("transform",function(a){return"translate("+(a.w-40)+","+(a.h+3)+")"}),e.selectAll("text.node_badge_label").text(function(a,b){return a._def.badge?"function"==typeof a._def.badge?a._def.badge.call(a):a._def.badge:""})}if(_&&b.status){e.selectAll(".node_status_group").style("display","inline").attr("transform","translate(3,"+(b.h+3)+")");var o=fa[b.status.fill];if(null==b.status.shape&&null==o)e.selectAll(".node_status").style("display","none");else{var q;null==b.status.shape||"dot"==b.status.shape?q={display:"inline",fill:o,stroke:o}:"ring"==b.status.shape&&(q={display:"inline",fill:"#fff",stroke:o}),e.selectAll(".node_status").style(q)}b.status.text?e.selectAll(".node_status_label").text(b.status.text):e.selectAll(".node_status_label").text("")}else e.selectAll(".node_status_group").style("display","none");b.dirty=!1}});var h=ha.selectAll(".link").data(O,function(a){return a.source.id+":"+a.sourcePort+":"+a.target.id+":"+a.target.i}),i=h.enter().insert("g",".node").attr("class","link");i.each(function(a,b){var c=d3.select(this);a.added=!0,c.append("svg:path").attr("class","link_background link_path").on("mousedown",function(a){Q=a,j(),P=Q,k(),x(),y(),d3.event.stopPropagation()}).on("touchstart",function(a){Q=a,j(),P=Q,k(),x(),y(),d3.event.stopPropagation();var b=d3.select(document.body),c=d3.event.touches.item(0),d=[c.pageX,c.pageY];K=setTimeout(function(){K=null,w(b,d)},G)}),c.append("svg:path").attr("class","link_outline link_path"),c.append("svg:path").attr("class","link_line link_path").classed("link_subflow",function(a){return M&&("subflow"===a.source.type||"subflow"===a.target.type)})}),h.exit().remove();var l=ha.selectAll(".link_path");l.each(function(b){var c=d3.select(this);(b.added||b===P||b.selected||a[b.source.id]||a[b.target.id])&&c.attr("d",function(a){var b=a.source.outputs||1,c=a.sourcePort||0,d=13*-((b-1)/2)+13*c,e=a.target.y-(a.source.y+d),f=a.target.x-a.target.w/2-(a.source.x+a.source.w/2),g=Math.sqrt(e*e+f*f),h=C,i=0;return E>g&&(h=.75-.75*((E-g)/E)),0>f&&(h+=2*(Math.min(5*E,Math.abs(f))/(5*E)),Math.abs(e)<3*F&&(i=(e>0?.5:-.5)*((3*F-Math.abs(e))/(3*F))*(Math.min(E,Math.abs(f))/E))),a.x1=a.source.x+a.source.w/2,a.y1=a.source.y+d,a.x2=a.target.x-a.target.w/2,a.y2=a.target.y,"M "+(a.source.x+a.source.w/2)+" "+(a.source.y+d)+" C "+(a.source.x+a.source.w/2+h*E)+" "+(a.source.y+d+i*F)+" "+(a.target.x-a.target.w/2-h*E)+" "+(a.target.y-i*F)+" "+(a.target.x-a.target.w/2)+" "+a.target.y})}),h.classed("link_selected",function(a){return a===P||a.selected}),h.classed("link_unknown",function(a){return delete a.added,"unknown"==a.target.type||"unknown"==a.source.type})}else ha.selectAll(".link_selected").data(O,function(a){return a.source.id+":"+a.sourcePort+":"+a.target.id+":"+a.target.i}).classed("link_selected",!1);d3.event&&d3.event.preventDefault()}function y(){$("#chart svg").focus()}function z(b,c){try{var d;M&&(d=M.changed);var e=RED.nodes["import"](b,!0);if(e){var f=e[0],g=e[1],h=e[2],i=e[3],k=f.filter(function(a){return a.hasOwnProperty("x")&&a.hasOwnProperty("y")&&a.z==RED.workspaces.active()}).map(function(a){return{n:a}}),l=f.map(function(a){return a.id});if(k.length>0){var m=k[0].n,n=m.x,o=m.y;null==W&&(W=[0,0]);var p,q,r=0,s=0;for(p=0;p<k.length;p++)q=k[p],q.n.selected=!0,q.n.changed=!0,q.n.x-=n-W[0],q.n.y-=o-W[1],q.dx=q.n.x-W[0],q.dy=q.n.y-W[1],r=Math.min(q.n.x-E/2-5,r),s=Math.min(q.n.y-F/2-5,s);for(p=0;p<k.length;p++)q=k[p],q.n.x-=r,q.n.y-=s,q.dx-=r,q.dy-=s;c||(X=RED.state.IMPORT_DRAGGING),RED.keyboard.add(27,function(){RED.keyboard.remove(27),j(),RED.history.pop(),X=0}),j(),Y=k}var t={t:"add",nodes:l,links:g,workspaces:h,subflows:i,dirty:RED.nodes.dirty()};if(M){var u=RED.subflow.refresh(!0);u&&(t.subflow={id:M.id,changed:d,instances:u.instances})}RED.history.push(t),a(),x()}}catch(v){"NODE_RED"!=v.code?(console.log(v.stack),RED.notify(RED._("notification.error",{message:v.toString()}),"error")):RED.notify(RED._("notification.error",{message:v.message}),"error")}}var A=5e3,B=5e3,C=.75,D=1,E=100,F=30,G=1e3,H=0,I=[],J=[],K=0,L={},M=null,N=[],O=[],P=null,Q=null,R=null,S=null,T=0,U=null,V=[0,0],W=null,X=0,Y=[],Z=null,_=!1,aa=null,ba=null,ca=0,da=0,ea="",fa={red:"#c00",green:"#5a8",yellow:"#F9DF31",blue:"#53A3F3",grey:"#d3d3d3"},ga=d3.select("#chart").append("svg:svg").attr("width",A).attr("height",B).attr("tabindex",1).attr("pointer-events","all").style("cursor","crosshair").on("mousedown",function(){$(this).focus()}),ha=ga.append("svg:g").on("dblclick.zoom",null).append("svg:g").on("mousemove",d).on("mousedown",c).on("mouseup",e).on("touchend",function(){clearTimeout(K),K=null,RED.touch.radialMenu.active()||(Z&&ia.attr("fill","#fff"),e.call(this))}).on("touchcancel",e).on("touchstart",function(){var a;if(d3.event.touches.length>1){clearTimeout(K),K=null,d3.event.preventDefault(),a=d3.event.touches.item(0);var b=d3.event.touches.item(1),c=a.pageY-b.pageY,d=a.pageX-b.pageX,e=$("#chart").offset(),f=[$("#chart").scrollLeft(),$("#chart").scrollTop()];I=[(b.pageX+d/2-e.left+f[0])/D,(b.pageY+c/2-e.top+f[1])/D],J=[b.pageX+d/2,b.pageY+c/2],H=Math.sqrt(c*c+d*d)}else{var g=d3.select(document.body);a=d3.event.touches.item(0);var h=[a.pageX,a.pageY];I=[a.pageX,a.pageY],H=0;d3.touches(this)[0];K=setTimeout(function(){K=null,w(g,h)},G)}}).on("touchmove",function(){if(RED.touch.radialMenu.active())return void d3.event.preventDefault();var a;if(d3.event.touches.length<2){if(K){a=d3.event.touches.item(0);var b=a.pageX-I[0],c=a.pageY-I[1],e=Math.abs(b*b+c*c);e>64&&(clearTimeout(K),K=null)}else Z&&d3.event.preventDefault();d.call(this)}else{a=d3.event.touches.item(0);var f=d3.event.touches.item(1),g=a.pageY-f.pageY,h=a.pageX-f.pageX,i=($("#chart").offset(),[$("#chart").scrollLeft(),$("#chart").scrollTop()]),j=Math.sqrt(g*g+h*h),k=[f.pageX+h/2,f.pageY+g/2];if(!isNaN(j)){oldScaleFactor=D,D=Math.min(2,Math.max(.3,D+Math.floor(100*j-100*H)/1e4));var l=[I[0]*(D-oldScaleFactor),I[1]*(D-oldScaleFactor)];H=j,J=k,$("#chart").scrollLeft(i[0]+l[0]),$("#chart").scrollTop(i[1]+l[1]),x()}}}),ia=ha.append("svg:rect").attr("width",A).attr("height",B).attr("fill","#fff"),ja=ha.append("svg:path").attr("class","drag_line");return{init:b,state:function(a){return null==a?X:void(X=a)},redraw:function(b){b&&a(),x()},focus:y,importNodes:z,status:function(a){return null==a?_:(_=a,RED.nodes.eachNode(function(a){a.dirty=!0}),x(),void 0)},calculateTextWidth:p,select:function(a){if("undefined"!=typeof a&&(j(),"string"==typeof a)){var b=RED.nodes.node(a);b&&(b.selected=!0,b.dirty=!0,Y=[{n:b}])}k(),x()},selection:function(){var a={};return Y.length>0&&(a.nodes=Y.map(function(a){return a.n})),null!=P&&(a.link=P),a}}}(),RED.sidebar=function(){function a(a,b,c,e){var f;"string"==typeof a?f={id:b.id,label:a,name:a,content:b,closeable:c,visible:e}:"object"==typeof a&&(f=a),$("#sidebar-content").append(f.content),$(f.content).hide();f.id;RED.menu.addItem("menu-item-sidebar-menu",{id:"menu-item-sidebar-menu-"+f.id,label:f.name,onselect:function(){d(f.id)},group:"sidebar-tabs"}),h[f.id]=f,f.visible!==!1&&g.addTab(h[f.id])}function b(a){g.removeTab(a),$(h[a].content).remove(),delete h[a],RED.menu.removeItem("menu-item-sidebar-menu-"+a)}function c(a){a?($("#main-container").removeClass("sidebar-closed"),g.resize()):$("#main-container").addClass("sidebar-closed"),RED.events.emit("sidebar:resize")}function d(a){a&&(e(a)||g.addTab(h[a]),g.activateTab(a),RED.menu.isSelected("menu-item-sidebar")||RED.menu.setSelected("menu-item-sidebar",!0))}function e(a){return g.contains(a)}function f(){RED.keyboard.add(32,{ctrl:!0},function(){RED.menu.setSelected("menu-item-sidebar",!RED.menu.isSelected("menu-item-sidebar")),d3.event.preventDefault()}),d(),RED.sidebar.info.init(),RED.sidebar.config.init(),$(window).width()<600&&c()}var g=RED.tabs.create({id:"sidebar-tabs",onchange:function(a){$("#sidebar-content").children().hide(),a.onchange&&a.onchange.call(a),$(a.content).show()},onremove:function(a){$(a.content).hide(),a.onremove&&a.onremove.call(a)},minimumActiveTabWidth:110}),h={},i={};return $("#sidebar-separator").draggable({axis:"x",start:function(a,b){i.closing=!1,i.opening=!1;var c=$(window).width();if(i.start=b.position.left,i.chartWidth=$("#workspace").width(),i.chartRight=c-$("#workspace").width()-$("#workspace").offset().left-2,!RED.menu.isSelected("menu-item-sidebar")){i.opening=!0;var d=7;$("#sidebar").addClass("closing"),$("#workspace").css("right",d),$("#sidebar").width(0),RED.menu.setSelected("menu-item-sidebar",!0),RED.events.emit("sidebar:resize")}i.width=$("#sidebar").width()},drag:function(a,b){var c=b.position.left-i.start,d=i.width-c;i.opening&&(d-=3),d>150&&i.chartWidth+c<200&&(b.position.left=200+i.start-i.chartWidth,c=b.position.left-i.start,d=i.width-c),150>d?(i.closing||($("#sidebar").addClass("closing"),i.closing=!0),i.opening||(d=150,b.position.left=i.width-(150-i.start),c=b.position.left-i.start)):d>150&&(i.closing||i.opening)&&(i.closing=!1,$("#sidebar").removeClass("closing"));var e=i.chartRight-c;$("#workspace").css("right",e),$("#sidebar").width(d),g.resize(),RED.events.emit("sidebar:resize")},stop:function(a,b){i.closing&&($("#sidebar").removeClass("closing"),RED.menu.setSelected("menu-item-sidebar",!1),$("#sidebar").width()<180&&($("#sidebar").width(180),$("#workspace").css("right",187))),$("#sidebar-separator").css("left","auto"),$("#sidebar-separator").css("right",$("#sidebar").width()+2+"px"),RED.events.emit("sidebar:resize")}}),{init:f,addTab:a,removeTab:b,show:d,containsTab:e,toggleSidebar:c}}(),RED.palette=function(){function a(a,b){b=b||a.replace("_"," ");var c=$('<div id="palette-container-'+a+'" class="palette-category palette-close hide"><div id="palette-header-'+a+'" class="palette-header"><i class="expanded fa fa-angle-down"></i><span>'+b+'</span></div><div class="palette-content" id="palette-base-category-'+a+'"><div id="palette-'+a+'-input"></div><div id="palette-'+a+'-output"></div><div id="palette-'+a+'-function"></div></div></div>').appendTo("#palette-container");m[a]={container:c,close:function(){c.removeClass("palette-open"),c.addClass("palette-closed"),$("#palette-base-category-"+a).slideUp(),$("#palette-header-"+a+" i").removeClass("expanded")},open:function(){c.addClass("palette-open"),c.removeClass("palette-closed"),$("#palette-base-category-"+a).slideDown(),$("#palette-header-"+a+" i").addClass("expanded")},toggle:function(){c.hasClass("palette-open")?m[a].close():m[a].open()}},$("#palette-header-"+a).on("click",function(b){m[a].toggle()})}function b(a,b,c,d){for(var e=82,f=20,g=c.split(" "),h=[],i=g[0],j=RED.view.calculateTextWidth(i,"palette_label",0),k=1;k<g.length;k++){var l=RED.view.calculateTextWidth(i+" "+g[k],"palette_label",0);e>l?(i+=" "+g[k],j=l):(h.push(i),i=g[k],j=RED.view.calculateTextWidth(i,"palette_label",0))}h.push(i);var m=h.join("<br/>"),n=8+f*h.length;b.css({height:n+"px"});var o=b.find(".palette_label");o.html(m),b.find(".palette_port").css({top:n/2-5+"px"});var p;try{var q="<p><b>"+c+"</b></p>";c!=a&&(q="<p><b>"+c+"</b><br/><i>"+a+"</i></p>"),p=$(q+(d?d:$("script[data-help-name|='"+a+"']").html()||"<p>"+RED._("palette.noInfo")+"</p>").trim()).filter(function(a){return 1==this.nodeType&&"P"==this.nodeName||3==this.nodeType&&this.textContent.trim().length>0}).slice(0,2)}catch(r){console.log("Error generating pop-over label for ",a),console.log(r.toString()),p="<p><b>"+c+"</b></p><p>"+RED._("palette.noInfo")+"</p>"}b.data("popover").setContent(p)}function c(a){return a.replace(" ","_").replace(".","_").replace(":","_")}function d(d,e){var f=c(d);if(!$("#palette_node_"+f).length&&-1===k.indexOf(e.category)){var g=e.category.replace(" ","_"),h=g.split("-")[0],i=document.createElement("div");i.id="palette_node_"+f,i.type=d;var j;if(j="undefined"==typeof e.paletteLabel?/^(.*?)([ -]in|[ -]out)?$/.exec(d)[1]:("function"==typeof e.paletteLabel?e.paletteLabel.call(e):e.paletteLabel)||"",$("<div/>",{"class":"palette_label"+("right"==e.align?" palette_label_right":"")}).appendTo(i),i.className="palette_node",e.icon){var n="function"==typeof e.icon?e.icon.call({}):e.icon,o=$("<div/>",{"class":"palette_icon_container"+("right"==e.align?" palette_icon_container_right":"")}).appendTo(i);$("<div/>",{"class":"palette_icon",style:"background-image: url(icons/"+n+")"}).appendTo(o)}if(i.style.backgroundColor=e.color,e.outputs>0){var p=document.createElement("div");p.className="palette_port palette_port_output",i.appendChild(p)}if(e.inputs>0){var q=document.createElement("div");q.className="palette_port palette_port_input",i.appendChild(q)}if(0===$("#palette-base-category-"+h).length)if(-1!==l.indexOf(h))a(h,RED._("node-red:palette.label."+h,{defaultValue:h}));else{var r=e.set.id;a(h,RED._(r+":palette.label."+h,{defaultValue:h}))}$("#palette-container-"+h).show(),0===$("#palette-"+g).length&&$("#palette-base-category-"+h).append('<div id="palette-'+g+'"></div>'),$("#palette-"+g).append(i),i.onmousedown=function(a){a.preventDefault()},RED.popover.create({target:$(i),content:"hi",delay:{show:750,hide:50}}),$(i).click(function(){RED.view.focus();var a;a=0===d.indexOf("subflow:")?marked(RED.nodes.subflow(d.substring(8)).info||""):$("script[data-help-name|='"+i.type+"']").html()||"";var b='<div class="node-help">'+a+"</div>";RED.sidebar.info.set(b)}),$(i).draggable({helper:"clone",appendTo:"body",revert:!0,revertDuration:50,start:function(){RED.view.focus()}});var s=null;"subflows"==e.category&&($(i).dblclick(function(a){RED.workspaces.show(d.substring(8)),a.preventDefault()}),s=marked(e.info||"")),b(d,$(i),j,s);var t=$("#palette-container-"+g);1===t.find(".palette_node").length&&m[g].open()}}function e(a){var b=c(a),d=$("#palette_node_"+b),e=d.closest(".palette-category");d.remove(),0===e.find(".palette_node").length&&e.find("i").hasClass("expanded")&&(e.find(".palette-content").slideToggle(),e.find("i").toggleClass("expanded"))}function f(a){var b=c(a);$("#palette_node_"+b).hide()}function g(a){var b=c(a);$("#palette_node_"+b).show()}function h(){RED.nodes.eachSubflow(function(a){var c=$("#palette_node_subflow_"+a.id.replace(".","_")),d=c.find(".palette_port_input"),e=c.find(".palette_port_output");if(0===d.length&&a["in"].length>0){var f=document.createElement("div");f.className="palette_port palette_port_input",c.append(f)}else 0!==d.length&&0===a["in"].length&&d.remove();if(0===e.length&&a.out.length>0){var g=document.createElement("div");g.className="palette_port palette_port_output",c.append(g)}else 0!==e.length&&0===a.out.length&&e.remove();b(a.type+":"+a.id,c,a.name,marked(a.info||""))})}function i(){var a=$("#palette-search-input").val();""===a?$("#palette-search-clear").hide():$("#palette-search-clear").show();var b=new RegExp(a,"i");$(".palette_node").each(function(c,d){var e=$(d).find(".palette_label").text();""===a||b.test(d.id)||b.test(e)?$(this).show():$(this).hide()});for(var c in m)m.hasOwnProperty(c)&&(0===m[c].container.find(".palette_node").filter(function(){return"none"!==$(this).css("display")}).length?m[c].close():m[c].open())}function j(){$(".palette-spinner").show(),RED.settings.paletteCategories?RED.settings.paletteCategories.forEach(function(b){a(b,RED._("palette.label."+b,{defaultValue:b}))}):l.forEach(function(b){a(b,RED._("palette.label."+b,{defaultValue:b}))}),$("#palette-search-input").focus(function(a){RED.keyboard.disable()}),$("#palette-search-input").blur(function(a){RED.keyboard.enable()}),$("#palette-search-clear").on("click",function(a){a.preventDefault(),$("#palette-search-input").val(""),i(),$("#palette-search-input").focus()}),$("#palette-search-input").val(""),$("#palette-search-input").on("keyup",function(){i()}),$("#palette-search-input").on("focus",function(){$("body").one("mousedown",function(){$("#palette-search-input").blur()})}),$("#palette-collapse-all").on("click",function(a){a.preventDefault();for(var b in m)m.hasOwnProperty(b)&&m[b].close()}),$("#palette-expand-all").on("click",function(a){a.preventDefault();for(var b in m)m.hasOwnProperty(b)&&m[b].open()})}var k=["config","unknown","deprecated"],l=["subflows","input","output","function","social","mobile","storage","analysis","advanced"],m={};return{init:j,add:d,remove:e,hide:f,show:g,refresh:h}}(),RED.sidebar.info=function(){function a(){RED.sidebar.addTab({id:"info",label:RED._("sidebar.info.label"),name:RED._("sidebar.info.name"),content:g})}function b(){RED.sidebar.show("info")}function c(a,b){if(""===a)return b;var c=typeof b;return $.isArray(b)?"[array:"+b.length+"]":"object"===c?"[object]":"string"===c&&b.length>30?b.substring(0,30)+" ...":b}function d(a){var b='<table class="node-info"><tbody>';b+='<tr class="blank"><td colspan="2">'+RED._("sidebar.info.node")+"</td></tr>","subflow"!=a.type&&a.name&&(b+="<tr><td>"+RED._("common.label.name")+"</td><td>&nbsp;"+a.name+"</td></tr>"),b+="<tr><td>"+RED._("sidebar.info.type")+"</td><td>&nbsp;"+a.type+"</td></tr>",b+="<tr><td>"+RED._("sidebar.info.id")+"</td><td>&nbsp;"+a.id+"</td></tr>";var d,e=/^subflow(:(.+))?$/.exec(a.type);if(e){d=e[2]?RED.nodes.subflow(e[2]):a,b+='<tr class="blank"><td colspan="2">'+RED._("sidebar.info.subflow")+"</td></tr>";var f=0,i="subflow:"+d.id;RED.nodes.eachNode(function(a){a.type===i&&f++}),b+="<tr><td>"+RED._("common.label.name")+"</td><td>"+d.name+"</td></tr>",b+="<tr><td>"+RED._("sidebar.info.instances")+"</td><td>"+f+"</td></tr>"}if(!e&&"subflow"!=a.type&&"comment"!=a.type&&(b+='<tr class="blank"><td colspan="2"><a href="#" class="node-info-property-header"><i style="width: 10px; text-align: center;" class="fa fa-caret-'+(h?"down":"right")+'"></i> '+RED._("sidebar.info.properties")+"</a></td></tr>",a._def))for(var j in a._def.defaults)if("name"!=j&&a._def.defaults.hasOwnProperty(j)){var k=a[j]||"",l=typeof k;if("string"===l)0===k.length?k+='<span style="font-style: italic; color: #ccc;">'+RED._("sidebar.info.blank")+"</span>":(k.length>30&&(k=k.substring(0,30)+" ..."),k=k.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));else if("number"===l)k=k.toString();else if($.isArray(k)){k="[<br/>";for(var m=0;m<Math.min(a[j].length,10);m++){var n=JSON.stringify(a[j][m],c," ").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");k+="&nbsp;"+m+": "+n+"<br/>"}a[j].length>10&&(k+="&nbsp;... "+RED._("sidebar.info.arrayItems",{count:a[j].length})+"<br/>"),k+="]"}else k=JSON.stringify(k,c," "),k=k.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");b+='<tr class="node-info-property-row'+(h?"":" hide")+'"><td>'+j+"</td><td>"+k+"</td></tr>"}if(b+="</tbody></table><hr/>",!d&&"comment"!=a.type){var o=$("script[data-help-name|='"+a.type+"']").html()||"";b+='<div class="node-help">'+o+"</div>"}if(d)b+='<div class="node-help">'+marked(d.info||"")+"</div>";else if(a._def&&a._def.info){var p=a._def.info;b+='<div class="node-help">'+marked("function"==typeof p?p.call(a):p)+"</div>"}$(g).html(b),$(".node-info-property-header").click(function(a){var b=$(this).find("i");b.hasClass("fa-caret-right")?(b.removeClass("fa-caret-right"),b.addClass("fa-caret-down"),$(".node-info-property-row").show(),h=!0):(b.addClass("fa-caret-right"),b.removeClass("fa-caret-down"),$(".node-info-property-row").hide(),h=!1),a.preventDefault()})}function e(){$(g).html("")}function f(a){$(g).html(a)}marked.setOptions({renderer:new marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1});var g=document.createElement("div");g.style.paddingTop="4px",g.style.paddingLeft="4px",g.style.paddingRight="4px",g.className="sidebar-node-info";var h=!1;return RED.events.on("view:selection-changed",function(a){if(a.nodes){if(1==a.nodes.length){var b=a.nodes[0];d("subflow"===b.type&&b.direction?RED.nodes.subflow(b.z):b)}}else{var c=RED.nodes.subflow(RED.workspaces.active());c?d(c):e()}}),{init:a,show:b,refresh:d,clear:e,set:f}}(),RED.sidebar.config=function(){function a(a,b){if(a.sort(function(a,b){return a.type<b.type?-1:a.type>b.type?1:0}),b.empty(),0===a.length)$('<li class="config_node_none" data-i18n="sidebar.config.none">NONE</li>').i18n().appendTo(b);else{var c="";a.forEach(function(a){var d="";d="function"==typeof a._def.label?a._def.label.call(a):a._def.label,d=d||a.id,a.type!=c&&($('<li class="config_node_type">'+a.type+"</li>").appendTo(b),c=a.type);var e=$('<li class="palette_node config_node"></li>').appendTo(b);$('<div class="palette_label"></div>').text(d).appendTo(e);$("<div/>",{"class":"palette_icon_container  palette_icon_container_right"}).text(a.users.length).appendTo(e);0===a.users.length&&e.addClass("config_node_unused"),e.on("click",function(b){RED.sidebar.info.refresh(a)}),e.on("dblclick",function(b){RED.editor.editConfig("",a.type,a.id)});var f=a.users.map(function(a){return a.id});e.on("mouseover",function(a){RED.nodes.eachNode(function(a){-1!=f.indexOf(a.id)&&(a.highlighted=!0,a.dirty=!0)}),RED.view.redraw()}),e.on("mouseout",function(a){RED.nodes.eachNode(function(a){a.highlighted&&(a.highlighted=!1,a.dirty=!0)}),RED.view.redraw()})})}}function b(){var b=[],c=[];RED.nodes.eachConfig(function(a){a.z==RED.workspaces.active()?b.push(a):a.z||c.push(a)}),a(b,$("#workspace-config-node-tray-locals")),a(c,$("#workspace-config-node-tray-globals"))}function c(){RED.sidebar.addTab({id:"config",label:RED._("sidebar.config.label"),name:RED._("sidebar.config.name"),content:e,closeable:!0,visible:!1,onchange:function(){b()}}),$(".workspace-config-node-tray-header").on("click",function(a){var b=$(this).find("i");b.hasClass("expanded")?(b.removeClass("expanded"),$(this).next().slideUp()):(b.addClass("expanded"),$(this).next().slideDown())})}function d(){b(),RED.sidebar.show("config")}var e=document.createElement("div");return e.className="sidebar-node-config",$('<div class="palette-category"><div class="workspace-config-node-tray-header palette-header"><i class="fa fa-angle-down expanded"></i><span data-i18n="sidebar.config.local"></span></div><ul id="workspace-config-node-tray-locals" class="palette-content config-node-list"></ul></div><div class="palette-category"><div class="workspace-config-node-tray-header palette-header"><i class="fa fa-angle-down expanded"></i><span data-i18n="sidebar.config.global"></span></div><ul id="workspace-config-node-tray-globals" class="palette-content config-node-list"></ul></div>').appendTo(e),{init:c,show:d,refresh:b}}(),RED.editor=function(){function a(a,b){var c=a.replace(/\s+/g,"-");return"credentials/"+c+"/"+b}function b(a){var d=a.valid,e=a.changed;a.valid=!0;var f,g,h;if(0===a.type.indexOf("subflow:"))f=RED.nodes.subflow(a.type.substring(8)),g=f.valid,h=f.changed,void 0===g&&(g=b(f),h=f.changed),a.valid=g,a.changed=a.changed||h;else if(a._def)a.valid=c(a,a._def.defaults,a),a._def._creds&&(a.valid=a.valid&&c(a,a._def.credentials,a._def._creds));else if("subflow"==a.type){for(var i=RED.nodes.filterNodes({z:a.id}),j=0;j<i.length;j++)g=i[j].valid,h=i[j].changed,void 0===g&&(g=b(i[j]),h=i[j].changed),a.valid=a.valid&&g,a.changed=a.changed||h;var k=RED.nodes.filterNodes({type:"subflow:"+a.id}),l={};for(j=0;j<k.length;j++)k[j].valid=a.valid,k[j].changed=k[j].changed||a.changed,k[j].dirty=!0,l[k[j].z]=!0;Object.keys(l).forEach(function(a){var c=RED.nodes.subflow(a);c&&b(c)})}return(d!==a.valid||e!==a.changed)&&(a.dirty=!0,f=RED.nodes.subflow(a.z),f&&b(f)),a.valid}function c(a,b,c){var e=!0;for(var f in b)b.hasOwnProperty(f)&&(d(a,b,f,c[f])||(e=!1));return e}function d(a,b,c,d){var e=!0;if("required"in b[c]&&b[c].required&&(e=""!==d),e&&"validate"in b[c]&&(e=b[c].validate.call(a,d)),e&&b[c].type&&RED.nodes.getType(b[c].type)&&!("validate"in b[c]))if(d&&"_ADD_"!=d){var f=RED.nodes.node(d).valid;e=null==f||f}else e=b[c].hasOwnProperty("required")&&!b[c].required;return e}function e(a){a.resize=!0,a.dirty=!0;var b=[];if(a.ports)if(a.outputs<a.ports.length){for(;a.outputs<a.ports.length;)a.ports.pop();RED.nodes.eachLink(function(c){c.source===a&&c.sourcePort>=a.outputs&&b.push(c);
})}else if(a.outputs>a.ports.length)for(;a.outputs>a.ports.length;)a.ports.push(a.ports.length);0===a.inputs&&b.concat(RED.nodes.filterLinks({target:a}));for(var c=0;c<b.length;c++)RED.nodes.removeLink(b[c]);return b}function f(){$("#dialog").dialog({modal:!0,autoOpen:!1,dialogClass:"ui-dialog-no-close",closeOnEscape:!1,minWidth:500,width:"auto",buttons:[{id:"node-dialog-ok",text:RED._("common.label.ok"),click:function(){if(u){var a,c={},d=!1,f=RED.nodes.dirty();if(u._def.oneditsave){var g={};for(a in u._def.defaults)u._def.defaults.hasOwnProperty(a)&&("string"==typeof u[a]||"number"==typeof u[a]?g[a]=u[a]:g[a]=$.extend(!0,{},{v:u[a]}).v);var h=u._def.oneditsave.call(u);h===!0&&(d=!0);for(a in u._def.defaults)u._def.defaults.hasOwnProperty(a)&&(null===g[a]||"string"==typeof g[a]||"number"==typeof g[a]?g[a]!==u[a]&&(c[a]=g[a],d=!0):JSON.stringify(g[a])!==JSON.stringify(u[a])&&(c[a]=g[a],d=!0))}if(u._def.defaults)for(a in u._def.defaults)if(u._def.defaults.hasOwnProperty(a)){var i,j=$("#node-input-"+a);if(i="checkbox"===j.attr("type")?j.prop("checked"):j.val(),null!=i){if("outputs"===a&&(""===i.trim()||isNaN(i)))continue;if(u[a]!=i){if(u._def.defaults[a].type){"_ADD_"==i&&(i="");var k=RED.nodes.node(u[a]);if(k){var m=k.users;m.splice(m.indexOf(u),1)}k=RED.nodes.node(i),k&&k.users.push(u)}c[a]=u[a],u[a]=i,d=!0}}}if(u._def.credentials){var n="node-input",o=u._def.credentials,p=l(u,o,n);d=d||p}var q=e(u);if(d){var r=u.changed;u.changed=!0,RED.nodes.dirty(!0);var s=RED.nodes.subflow(RED.workspaces.active()),t=null;s&&(t=[],RED.nodes.eachNode(function(a){a.type=="subflow:"+RED.workspaces.active()&&(t.push({id:a.id,changed:a.changed}),a.changed=!0,a.dirty=!0,e(a))}));var v={t:"edit",node:u,changes:c,links:q,dirty:f,changed:r};t&&(v.subflow={instances:t}),RED.history.push(v)}u.dirty=!0,b(u),RED.view.redraw()}else if(/Export nodes to library/.test($("#dialog").dialog("option","title"))){var w=$("#node-input-filename").val();/^\s*$/.test(w)||$.ajax({url:"library/flows/"+w,type:"POST",data:$("#node-input-filename").attr("nodes"),contentType:"application/json; charset=utf-8"}).done(function(){RED.library.loadFlowLibrary(),RED.notify(RED._("library.savedNodes"),"success")}).fail(function(a,b,c){RED.notify(RED._("library.saveFailed",{message:a.responseText}),"error")})}$(this).dialog("close")}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){if(u&&u._def){u._def.oneditcancel&&u._def.oneditcancel.call(u);for(var a in u._def.defaults)if(u._def.defaults.hasOwnProperty(a)){var b=u._def.defaults[a];if(b.type){var c=RED.nodes.getType(b.type);if(c&&c.exclusive){var d=$("#node-input-"+a).val()||"";""===d||u[a]||RED.nodes.remove(d)}}}}$(this).dialog("close")}}],resize:function(a,b){u&&$(this).dialog("option","sizeCache-"+u.type,b.size)},open:function(a){var b=$(this).dialog("option","minWidth");if($(this).outerWidth()<b?$(this).dialog("option","width",b):$(this).dialog("option","width",$(this).outerWidth()),RED.keyboard.disable(),u){var c=$(this).dialog("option","sizeCache-"+u.type);c&&($(this).dialog("option","width",c.width),$(this).dialog("option","height",c.height))}},close:function(a){RED.keyboard.enable(),RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),$(this).dialog("option","height","auto"),$(this).dialog("option","width","auto"),u&&RED.sidebar.info.refresh(u),RED.workspaces.refresh();var b=$(this).dialog("option","buttons");3==b.length&&$(this).dialog("option","buttons",b.splice(1)),u=null}})}function g(a,b,c){var d=$("#node-input-"+b),e=RED.nodes.getType(c);d.replaceWith('<select style="width: 60%;" id="node-input-'+b+'"></select>'),p(b,c,a[b]);var f=$("#node-input-"+b);f.after(' <a id="node-input-lookup-'+b+'" class="editor-button"><i class="fa fa-pencil"></i></a>'),$("#node-input-lookup-"+b).click(function(a){o(b,c,f.find(":selected").val()),a.preventDefault()});var g="",h=RED.nodes.node(a[b]);h&&e.label&&(g="function"==typeof e.label?e.label.call(h):e.label),d.val(g)}function h(a,b,c){var d=$("#node-input-"+b);d.val(a[b]),d.attr("type","hidden");var e=$("<a>",{id:"node-input-edit-"+b,"class":"editor-button"});d.after(e),a[b]?e.text(RED._("editor.configEdit")):e.text(RED._("editor.configAdd")),e.click(function(a){o(b,c,d.val()||"_ADD_"),a.preventDefault()})}function i(a,b,c){var d=$("#"+c+"-"+b);if("checkbox"===d.attr("type"))d.prop("checked",a[b]);else{var e=a[b];null==e&&(e=""),d.val(e)}}function j(a,b,c,e){$("#"+e+"-"+c).change(function(){d(a,b,c,this.value)?$(this).removeClass("input-error"):$(this).addClass("input-error")})}function k(a,b,c,d){var e;for(e in b)b.hasOwnProperty(e)&&("password"==b[e].type?c[e]?$("#"+d+"-"+e).val(c[e]):c["has_"+e]?$("#"+d+"-"+e).val("__PWRD__"):$("#"+d+"-"+e).val(""):i(c,e,d),j(a,b,e,d));for(e in b)b.hasOwnProperty(e)&&$("#"+d+"-"+e).change()}function l(a,b,c){var d=!1;a.credentials||(a.credentials={_:{}});for(var e in b)if(b.hasOwnProperty(e)){var f=$("#"+c+"-"+e),g=f.val();if("password"==b[e].type){if(a.credentials["has_"+e]=""!==g,"__PWRD__"==g)continue;d=!0}a.credentials[e]=g,g!=a.credentials._[e]&&(d=!0)}return d}function m(b,c,d){for(var e in c.defaults)if(c.defaults.hasOwnProperty(e)){if(c.defaults[e].type){var f=RED.nodes.getType(c.defaults[e].type);f?f.exclusive?h(b,e,c.defaults[e].type):g(b,e,c.defaults[e].type):(console.log("Unknown type:",c.defaults[e].type),i(b,e,d))}else i(b,e,d);j(b,c.defaults,e,d)}var l=function(){c.oneditprepare&&c.oneditprepare.call(b);for(var a in c.defaults)c.defaults.hasOwnProperty(a)&&$("#"+d+"-"+a).change()};c.credentials?b.credentials?(k(b,c.credentials,b.credentials,d),l()):$.getJSON(a(b.type,b.id),function(a){b.credentials=a,b.credentials._=$.extend(!0,{},a),k(b,c.credentials,b.credentials,d),l()}):l()}function n(a){u=a,RED.view.state(RED.state.EDITING);var b=a.type;if("subflow:"==a.type.substring(0,8)){b="subflow";var c=u.type.substring(8),d=$("#dialog").dialog("option","buttons");d.unshift({"class":"leftButton",text:RED._("subflow.edit"),click:function(){RED.workspaces.show(c),$("#node-dialog-ok").click()}}),$("#dialog").dialog("option","buttons",d)}$("#dialog-form").html($("script[data-template-name='"+b+"']").html());var e;e="node-red"===a._def.set.module?"node-red":a._def.set.id,$("#dialog-form").find("[data-i18n]").each(function(){for(var a=$(this).attr("data-i18n"),b=a.split(";"),c=0;c<b.length;c++){var d=b[c];if(-1===d.indexOf(":")){var f="";if(0===d.indexOf("[")){var g=d.split("]");f=g[0]+"]",d=g[1]}b[c]=f+e+":"+d}}$(this).attr("data-i18n",b.join(";"))}),$('<input type="text" style="display: none;" />').appendTo("#dialog-form"),m(a,a._def,"node-input"),$("#dialog").i18n(),$("#dialog").dialog("option","title","Edit "+b+" node").dialog("open")}function o(a,c,d){var e="_ADD_"==d,f=RED.nodes.getType(c);v=RED.nodes.node(d);var g;g="node-red"===f.set.module?"node-red":f.set.id;var h=RED.nodes.workspace(RED.workspaces.active());if(h||(h=RED.nodes.subflow(RED.workspaces.active())),null==v){v={id:(1+4294967295*Math.random()).toString(16),_def:f,type:c,z:h.id,users:[]};for(var i in f.defaults)f.defaults[i].value&&(v[i]=f.defaults[i].value);v._=f._}$("#node-config-dialog-edit-form").html($("script[data-template-name='"+c+"']").html()),$("#dialog-config-form").find("[data-i18n]").each(function(){var a=$(this).attr("data-i18n");if(-1===a.indexOf(":")){var b="";if(0===a.indexOf("[")){var c=a.split("]");b=c[0]+"]",a=c[1]}$(this).attr("data-i18n",b+g+":"+a)}}),m(v,f,"node-config-input");var j=$("#node-config-dialog").dialog("option","buttons");e?(3==j.length&&(j=j.splice(1)),j[0].text="Add",$("#node-config-dialog-user-count").find("span").html("").parent().hide()):(2==j.length&&j.unshift({"class":"leftButton",text:RED._("editor.configDelete"),click:function(){var a=$(this).dialog("option","node-property"),c=$(this).dialog("option","node-id"),d=$(this).dialog("option","node-type"),e=RED.nodes.getType(d);e.ondelete&&e.ondelete.call(v),e.oneditdelete&&e.oneditdelete.call(v);var f={t:"delete",nodes:[v],changes:{},dirty:RED.nodes.dirty()};RED.nodes.remove(c);for(var g=0;g<v.users.length;g++){var h=v.users[g];f.changes[h.id]={changed:h.changed,valid:h.valid};for(var i in h._def.defaults)h._def.defaults.hasOwnProperty(i)&&h[i]==c&&(f.changes[h.id][i]=c,h[i]="",h.changed=!0,h.dirty=!0);b(h)}p(a,d,""),RED.nodes.dirty(!0),$(this).dialog("close"),RED.view.redraw(),RED.history.push(f)}}),j[1].text="Update",$("#node-config-dialog-user-count").find("span").html(RED._("editor.nodesUse",{count:v.users.length})).parent().show()),v._def.exclusive?$("#node-config-dialog-scope").hide():$("#node-config-dialog-scope").show(),$("#node-config-dialog-scope-warning").hide();var k={};v.users.forEach(function(a){k[a.z]=!0});var l=Object.keys(k).length,n=$("#node-config-dialog-scope").empty();n.off("change"),n.append('<option value=""'+(v.z?"":" selected")+' data-i18n="sidebar.config.global"></option>'),n.append('<option disabled data-i18n="sidebar.config.flows"></option>'),RED.nodes.eachWorkspace(function(a){var b=a.label;k[a.id]&&(b="* "+b),n.append('<option value="'+a.id+'"'+(a.id==v.z?" selected":"")+">"+b+"</option>")}),n.append('<option disabled data-i18n="sidebar.config.subflows"></option>'),RED.nodes.eachSubflow(function(a){var b=a.name;k[a.id]&&(b="* "+b),n.append('<option value="'+a.id+'"'+(a.id==v.z?" selected":"")+">"+b+"</option>")}),l>0&&n.on("change",function(){var a=$(this).val();""===a?$("#node-config-dialog-scope-warning").hide():!k[a]||l>1?$("#node-config-dialog-scope-warning").show():$("#node-config-dialog-scope-warning").hide()}),n.i18n(),$("#node-config-dialog").dialog("option","buttons",j),$("#node-config-dialog").i18n(),$("#node-config-dialog").dialog("option","node-adding",e).dialog("option","node-property",a).dialog("option","node-id",v.id).dialog("option","node-type",c).dialog("option","title",e?RED._("editor.addNewConfig",{type:c}):RED._("editor.editConfig",{type:c})).dialog("open")}function p(a,b,c){var d=$("#node-input-edit-"+a);if(d.length)c?d.text(RED._("editor.configEdit")):d.text(RED._("editor.configAdd")),$("#node-input-"+a).val(c);else{var e=$("#node-input-"+a),f=RED.nodes.getType(b);e.children().remove();var g=RED.nodes.workspace(RED.workspaces.active());g||(g=RED.nodes.subflow(RED.workspaces.active()));var h=[];RED.nodes.eachConfig(function(a){if(a.type==b&&(!a.z||a.z===g.id)){var c="";c="function"==typeof f.label?f.label.call(a):f.label,h.push({id:a.id,label:c})}}),h.sort(function(a,b){return a.label<b.label?-1:a.label>b.label?1:0}),h.forEach(function(a){e.append('<option value="'+a.id+'"'+(c==a.id?" selected":"")+">"+a.label+"</option>")}),e.append('<option value="_ADD_"'+(""===c?" selected":"")+">"+RED._("editor.addNewType",{type:b})+"</option>"),window.setTimeout(function(){e.change()},50)}}function q(){$("#node-config-dialog").dialog({modal:!0,autoOpen:!1,dialogClass:"ui-dialog-no-close",minWidth:500,width:"auto",closeOnEscape:!1,buttons:[{id:"node-config-dialog-ok",text:RED._("common.label.ok"),click:function(){var a,c,d=$(this).dialog("option","node-property"),e=($(this).dialog("option","node-id"),$(this).dialog("option","node-type")),f=$(this).dialog("option","node-adding"),g=RED.nodes.getType(e),h=$("#node-config-dialog-scope").val();for(a in g.defaults)g.defaults.hasOwnProperty(a)&&(c=$("#node-config-input-"+a),"checkbox"===c.attr("type")?v[a]=c.prop("checked"):v[a]=c.val());v.label=g.label,v.z=h,h&&(v.users=v.users.filter(function(a){var c=!0;for(var d in a._def.defaults)a._def.defaults.hasOwnProperty(d)&&a._def.defaults[d].type===v.type&&a[d]===v.id&&a.z!==h&&(c=!1,a[d]=null,a.dirty=!0,a.changed=!0,b(a));return c})),f&&RED.nodes.add(v),p(d,e,v.id),g.credentials&&l(v,g.credentials,"node-config-input"),g.oneditsave&&g.oneditsave.call(v),b(v);for(var i=0;i<v.users.length;i++){var j=v.users[i];b(j)}RED.nodes.dirty(!0),RED.view.redraw(!0),$(this).dialog("close")}},{id:"node-config-dialog-cancel",text:RED._("common.label.cancel"),click:function(){var a=$(this).dialog("option","node-type"),b=$(this).dialog("option","node-id"),c=($(this).dialog("option","node-adding"),RED.nodes.getType(a));if(c.oneditcancel&&c.oneditcancel){var d=RED.nodes.node(b);d?c.oneditcancel.call(d,!1):c.oneditcancel.call({id:b},!0)}$(this).dialog("close")}}],resize:function(a,b){},open:function(a){var b=$(this).dialog("option","minWidth");$(this).outerWidth()<b&&$(this).dialog("option","width",b),RED.view.state()!=RED.state.EDITING&&RED.keyboard.disable()},close:function(a){$(this).dialog("option","width","auto"),$(this).dialog("option","height","auto"),$("#node-config-dialog-edit-form").html(""),RED.view.state()!=RED.state.EDITING&&RED.keyboard.enable(),RED.workspaces.refresh()},create:function(){$("#node-config-dialog").parent().find("div.ui-dialog-buttonpane").prepend('<div id="node-config-dialog-user-count"><i class="fa fa-info-circle"></i> <span></span></div>'),$("#node-config-dialog").parent().find(".ui-dialog-titlebar").append('<span id="node-config-dialog-scope-container"><span id="node-config-dialog-scope-warning" data-i18n="[title]editor.errors.scopeChange"><i class="fa fa-warning"></i></span><select id="node-config-dialog-scope"></select></span>'),$("#node-config-dialog").parent().draggable({cancel:".ui-dialog-content, .ui-dialog-titlebar-close, #node-config-dialog-scope-container"})}})}function r(){$("#subflow-dialog").dialog({modal:!0,autoOpen:!1,dialogClass:"ui-dialog-no-close",closeOnEscape:!1,minWidth:500,width:"auto",buttons:[{id:"subflow-dialog-ok",text:RED._("common.label.ok"),click:function(){if(u){var a={},b=!1,c=RED.nodes.dirty(),d=$("#subflow-input-name").val();d!=u.name&&(a.name=u.name,u.name=d,b=!0,$("#menu-item-workspace-menu-"+u.id.replace(".","-")).text(d));var f=t.getValue();if(f!=u.info&&(a.info=u.info,u.info=f,b=!0),RED.palette.refresh(),b){var g=[];RED.nodes.eachNode(function(a){a.type=="subflow:"+u.id&&(g.push({id:a.id,changed:a.changed}),a.changed=!0,a.dirty=!0,e(a))});var h=u.changed;u.changed=!0,RED.nodes.dirty(!0);var i={t:"edit",node:u,changes:a,dirty:c,changed:h,subflow:{instances:g}};RED.history.push(i)}u.dirty=!0,RED.view.redraw()}$(this).dialog("close")}},{id:"subflow-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close"),u=null}}],create:function(a){$("#subflow-dialog form").submit(function(a){a.preventDefault()}),t=RED.editor.createEditor({id:"subflow-input-info-editor",mode:"ace/mode/markdown",value:""})},open:function(a){RED.keyboard.disable();var b=$(this).dialog("option","minWidth");$(this).outerWidth()<b&&$(this).dialog("option","width",b)},close:function(a){RED.keyboard.enable(),RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(u),RED.workspaces.refresh(),u=null},resize:function(a){for(var b=$("#subflow-dialog>form>div:not(.node-text-editor-row)"),c=($("#subflow-dialog>form>div.node-text-editor-row"),$("#subflow-dialog").height()),d=0;d<b.size();d++)c-=$(b[d]).outerHeight(!0);c-=parseInt($("#subflow-dialog>form").css("marginTop"))+parseInt($("#subflow-dialog>form").css("marginBottom")),$(".node-text-editor").css("height",c+"px"),t.resize()}})}function s(a){u=a,RED.view.state(RED.state.EDITING),$("#subflow-input-name").val(a.name),t.getSession().setValue(a.info,-1);var b=0,c="subflow:"+u.id;RED.nodes.eachNode(function(a){a.type===c&&b++}),$("#subflow-dialog-user-count").html(RED._("subflow.subflowInstances",{count:b})).show(),$("#subflow-dialog").dialog("option","title",RED._("subflow.editSubflow",{name:a.name})).dialog("open")}var t,u=null,v=null;return{init:function(){f(),q(),r()},edit:n,editConfig:o,editSubflow:s,validateNode:b,updateNodeProperties:e,createEditor:function(a){var b=ace.edit(a.id);b.setTheme("ace/theme/tomorrow");var c=b.getSession();return a.mode&&c.setMode(a.mode),a.foldStyle?c.setFoldStyle(a.foldStyle):c.setFoldStyle("markbeginend"),a.options?b.setOptions(a.options):b.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0}),b.$blockScrolling=1/0,a.value&&c.setValue(a.value,-1),b}}}(),RED.clipboard=function(){function a(){f=$('<div id="clipboard-dialog" class="hide"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,buttons:[{id:"clipboard-dialog-ok",text:RED._("common.label.ok"),click:function(){/Import/.test(f.dialog("option","title"))&&RED.view.importNodes($("#clipboard-import").val()),$(this).dialog("close")}},{id:"clipboard-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-close",text:RED._("common.label.close"),click:function(){$(this).dialog("close")}}],open:function(a){$(this).parent().find(".ui-dialog-titlebar-close").hide(),RED.keyboard.disable()},close:function(a){RED.keyboard.enable()}}),g=f.children(".dialog-form"),h='<div class="form-row"><label for="node-input-export" style="display: block; width:100%;"><i class="fa fa-clipboard"></i> '+RED._("clipboard.nodes")+'</label><textarea readonly style="resize: none; width: 100%; border-radius: 0px;font-family: monospace; font-size: 12px; background:#eee; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-export" rows="5"></textarea></div><div class="form-tips">'+RED._("clipboard.selectNodes")+"</div>",i='<div class="form-row"><textarea style="resize: none; width: 100%; border-radius: 0px;font-family: monospace; font-size: 12px; background:#eee; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-import" rows="5" placeholder="'+RED._("clipboard.pasteNodes")+'"></textarea></div>'}function b(){var a=$("#clipboard-import"),b=a.val();try{JSON.parse(b),a.removeClass("input-error"),$("#clipboard-dialog-ok").button("enable")}catch(c){""!==b&&a.addClass("input-error"),$("#clipboard-dialog-ok").button("disable")}}function c(){g.empty(),g.append($(i)),$("#clipboard-dialog-ok").show(),$("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-close").hide(),$("#clipboard-dialog-ok").button("disable"),$("#clipboard-import").keyup(b),$("#clipboard-import").on("paste",function(){setTimeout(b,10)}),f.dialog("option","title",RED._("clipboard.importNodes")).dialog("open")}function d(){g.empty(),g.append($(h)),$("#clipboard-dialog-ok").hide(),$("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-close").show();var a=RED.view.selection();if(a.nodes){var b=RED.nodes.createExportableNodeSet(a.nodes);$("#clipboard-export").val(JSON.stringify(b)).focus(function(){var a=$(this);a.select(),a.mouseup(function(){return a.unbind("mouseup"),!1})}),f.dialog("option","title",RED._("clipboard.exportNodes")).dialog("open")}}function e(){$("#dropTarget").hide(),RED.keyboard.remove(27)}var f,g,h,i;return{init:function(){a(),RED.events.on("view:selection-changed",function(a){a.nodes?(RED.menu.setDisabled("menu-item-export",!1),RED.menu.setDisabled("menu-item-export-clipboard",!1),RED.menu.setDisabled("menu-item-export-library",!1)):(RED.menu.setDisabled("menu-item-export",!0),RED.menu.setDisabled("menu-item-export-clipboard",!0),RED.menu.setDisabled("menu-item-export-library",!0))}),RED.keyboard.add(69,{ctrl:!0},function(){d(),d3.event.preventDefault()}),RED.keyboard.add(73,{ctrl:!0},function(){c(),d3.event.preventDefault()}),$("#chart").on("dragenter",function(a){-1!=$.inArray("text/plain",a.originalEvent.dataTransfer.types)&&($("#dropTarget").css({display:"table"}),RED.keyboard.add(27,e))}),$("#dropTarget").on("dragover",function(a){-1!=$.inArray("text/plain",a.originalEvent.dataTransfer.types)&&a.preventDefault()}).on("dragleave",function(a){e()}).on("drop",function(a){var b=a.originalEvent.dataTransfer.getData("text/plain");e(),RED.view.importNodes(b),a.preventDefault()})},"import":c,"export":d}}(),RED.library=function(){function a(){$.getJSON("library/flows",function(a){var b=function(a,c){var d,e,f,g=document.createElement("ul");if(g.id="menu-item-import-library-submenu",g.className="dropdown-menu",a.d)for(d in a.d)a.d.hasOwnProperty(d)&&(e=document.createElement("li"),e.className="dropdown-submenu pull-left",f=document.createElement("a"),f.href="#",f.innerHTML=d,e.appendChild(f),e.appendChild(b(a.d[d],c+(""!==c?"/":"")+d)),g.appendChild(e));if(a.f)for(d in a.f)a.f.hasOwnProperty(d)&&(e=document.createElement("li"),f=document.createElement("a"),f.href="#",f.innerHTML=a.f[d],f.flowName=c+(""!==c?"/":"")+a.f[d],f.onclick=function(){$.get("library/flows/"+this.flowName,function(a){RED.view.importNodes(a)})},e.appendChild(f),g.appendChild(e));return g},c=b(a,"");$("#menu-item-import-library-submenu").replaceWith(c)})}function b(a){function b(a){var b=document.createElement("li");return b.onmouseover=function(a){$(this).addClass("list-hover")},b.onmouseout=function(a){$(this).removeClass("list-hover")},b}function c(d,g){for(var h,i=document.createElement("ul"),j=0;j<g.length;j++){var k=g[j];"string"==typeof k?(h=b(k),h.onclick=function(){var b=k;return function(e){var f=$('<li class="active"><span class="divider">/</span> <a href="#">'+b+"</a></li>");$("a",f).click(function(e){$(this).parent().nextAll().remove(),$.getJSON("library/"+a.url+d+b,function(a){$("#node-select-library").children().first().replaceWith(c(d+b+"/",a))}),e.stopPropagation()});var g=$("#node-dialog-library-breadcrumbs");$(".active",g).removeClass("active"),g.append(f),$.getJSON("library/"+a.url+d+b,function(a){$("#node-select-library").children().first().replaceWith(c(d+b+"/",a))})}}(),h.innerHTML='<i class="fa fa-folder"></i> '+k+"</i>",i.appendChild(h)):(h=b(k),h.innerHTML=k.name,h.onclick=function(){var b=k;return function(c){$(".list-selected",i).removeClass("list-selected"),$(this).addClass("list-selected"),$.get("library/"+a.url+d+b.fn,function(a){e=b,f.setValue(a,-1)})}}(),i.appendChild(h))}return i}function d(b){var c=$("#node-input-name").val().replace(/(^\s*)|(\s*$)/g,"");""===c&&(c=RED._("library.unnamedType",{type:a.type}));var d=$("#node-dialog-library-save-filename").val().replace(/(^\s*)|(\s*$)/g,""),e=$("#node-dialog-library-save-folder").val().replace(/(^\s*)|(\s*$)/g,"");if(""===d||!/.+\.js$/.test(d))return void RED.notify(RED._("library.invalidFilename"),"warning");for(var f=e+(""===e?"":"/")+d,g={},h=0;h<a.fields.length;h++){var i=a.fields[h];"name"==i?g.name=c:g[i]=$("#node-input-"+i).val()}g.text=a.editor.getValue(),$.ajax({url:"library/"+a.url+"/"+f,type:"POST",data:JSON.stringify(g),contentType:"application/json; charset=utf-8"}).done(function(b,c,d){RED.notify(RED._("library.savedType",{type:a.type}),"success")}).fail(function(a,b,c){RED.notify(RED._("library.saveFailed",{message:a.responseText}),"error")})}var e=null,f=null;a.editor.setText&&(a.editor.setValue=function(b,c){a.editor.setText.call(a.editor,b)}),a.editor.getText&&(a.editor.getValue=a.editor.getText),$("#node-input-name").css("width","60%").after('<div class="btn-group" style="margin-left: 5px;"><a id="node-input-'+a.type+'-lookup" class="editor-button" data-toggle="dropdown"><i class="fa fa-book"></i> <i class="fa fa-caret-down"></i></a><ul class="dropdown-menu pull-right" role="menu"><li><a id="node-input-'+a.type+'-menu-open-library" tabindex="-1" href="#">'+RED._("library.openLibrary")+'</a></li><li><a id="node-input-'+a.type+'-menu-save-library" tabindex="-1" href="#">'+RED._("library.saveToLibrary")+"</a></li></ul></div>"),$("#node-input-"+a.type+"-menu-open-library").click(function(b){$("#node-select-library").children().remove();var d=$("#node-dialog-library-breadcrumbs");d.children().first().nextAll().remove(),f.setValue("",-1),$.getJSON("library/"+a.url,function(a){$("#node-select-library").append(c("/",a)),$("#node-dialog-library-breadcrumbs a").click(function(b){$(this).parent().nextAll().remove(),$("#node-select-library").children().first().replaceWith(c("/",a)),b.stopPropagation()}),$("#node-dialog-library-lookup").dialog("open")}),b.preventDefault()}),$("#node-input-"+a.type+"-menu-save-library").click(function(b){var c=$("#node-input-name").val().replace(/(^\s*)|(\s*$)/g,"");$("#node-dialog-library-save-folder").attr("value","");var d=c.replace(/[^\w-]/g,"-");""===d&&(d="unnamed-"+a.type),$("#node-dialog-library-save-filename").attr("value",d+".js"),$("#node-dialog-library-save").dialog("open"),b.preventDefault()}),f=ace.edit("node-select-library-text"),f.setTheme("ace/theme/tomorrow"),a.mode&&f.getSession().setMode(a.mode),f.setOptions({readOnly:!0,highlightActiveLine:!1,highlightGutterLine:!1}),f.renderer.$cursorLayer.element.style.opacity=0,f.$blockScrolling=1/0,$("#node-dialog-library-lookup").dialog({title:RED._("library.typeLibrary",{type:a.type}),modal:!0,autoOpen:!1,width:800,height:450,buttons:[{text:RED._("common.label.ok"),click:function(){if(e){for(var b=0;b<a.fields.length;b++){var c=a.fields[b];$("#node-input-"+c).val(e[c])}a.editor.setValue(f.getValue(),-1)}$(this).dialog("close")}},{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}}],open:function(a){var b=$("form",this);b.height(b.parent().height()-30),$("#node-select-library-text").height("100%"),$(".form-row:last-child",b).children().height(b.height()-60)},resize:function(a){var b=$("form",this);b.height(b.parent().height()-30),$(".form-row:last-child",b).children().height(b.height()-60)}}),$("#node-dialog-library-save-confirm").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.ok"),click:function(){d(!0),$(this).dialog("close")}},{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}}]}),$("#node-dialog-library-save").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.ok"),click:function(){d(!1),$(this).dialog("close")}},{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}}]})}function c(){var a=RED.nodes.createExportableNodeSet(RED.view.selection().nodes);$("#dialog-form").html($("script[data-template-name='export-library-dialog']").html()),$("#node-input-filename").attr("nodes",JSON.stringify(a)),$("#dialog").i18n(),$("#dialog").dialog("option","title",RED._("library.exportToLibrary")).dialog("open")}return{init:function(){RED.events.on("view:selection-changed",function(a){a.nodes?(RED.menu.setDisabled("menu-item-export",!1),RED.menu.setDisabled("menu-item-export-clipboard",!1),RED.menu.setDisabled("menu-item-export-library",!1)):(RED.menu.setDisabled("menu-item-export",!0),RED.menu.setDisabled("menu-item-export-clipboard",!0),RED.menu.setDisabled("menu-item-export-library",!0))}),RED.settings.theme("menu.menu-item-import-library")!==!1&&a()},create:b,loadFlowLibrary:a,"export":c}}(),RED.notify=function(){var a=[],b=0;return function(c,d,e,f){if(a.length>4)for(var g=a.length,h=0;g>4&&h<a.length;h+=1){var i=a[h];i.fixed||(window.clearTimeout(i.timeoutid),i.close(),g-=1)}var j=document.createElement("div");return j.id="red-notification-"+b,j.className="notification",j.fixed=e,d&&(j.className="notification notification-"+d),j.style.display="none",j.innerHTML=c,$("#notifications").append(j),$(j).slideDown(300),j.close=function(){var b=j;return function(){a.splice(a.indexOf(b),1),$(b).slideUp(300,function(){b.parentNode.removeChild(b)})}}(),e||(j.timeoutid=window.setTimeout(j.close,f||3e3)),a.push(j),b+=1,j}}(),RED.subflow=function(){function a(){return RED.nodes.subflow(RED.workspaces.active())}function b(a,b){var c={x:50,y:30};b||(c.x+=110);for(var d=0;d<a.out.length+a["in"].length;d++){var e;e=d<a.out.length?a.out[d]:a["in"][d-a.out.length],e.x==c.x&&e.y==c.y&&(c.x+=55,d=0)}return c}function c(){var a=RED.nodes.subflow(RED.workspaces.active());if(1!==a["in"].length){var c=b(a,!0),d={type:"subflow",direction:"in",z:a.id,i:a["in"].length,x:c.x,y:c.y,id:RED.nodes.id()},e=a["in"].length;a["in"].push(d),a.dirty=!0;var f=RED.nodes.dirty(),h=a.changed;a.changed=!0;var i=g(!0),j={t:"edit",node:a,dirty:f,changed:h,subflow:{inputCount:e,instances:i.instances}};RED.history.push(j),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-input-add").addClass("active"),$("#workspace-subflow-input-remove").removeClass("active")}}function d(){var a=RED.nodes.subflow(RED.workspaces.active());if(0!==a["in"].length){var b=a["in"][0],c=[];return RED.nodes.eachLink(function(d){"subflow"==d.source.type&&d.source.z==a.id&&d.source.i==b.i?c.push(d):d.target.type=="subflow:"+a.id&&c.push(d)}),c.forEach(function(a){RED.nodes.removeLink(a)}),a["in"]=[],$("#workspace-subflow-input-add").removeClass("active"),$("#workspace-subflow-input-remove").addClass("active"),a.changed=!0,{subflowInputs:[b],links:c}}}function e(a){var c=RED.nodes.subflow(RED.workspaces.active()),d=b(c,!1),e={type:"subflow",direction:"out",z:c.id,i:c.out.length,x:d.x,y:d.y,id:RED.nodes.id()},f=c.out.length;c.out.push(e),c.dirty=!0;var h=RED.nodes.dirty(),i=c.changed;c.changed=!0;var j=g(!0),k={t:"edit",node:c,dirty:h,changed:i,subflow:{outputCount:f,instances:j.instances}};RED.history.push(k),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-output .spinner-value").html(c.out.length)}function f(a){var b=RED.nodes.subflow(RED.workspaces.active());if(0!==b.out.length){"undefined"==typeof a&&(a=[b.out[b.out.length-1]]);var c=[];for(a.sort(function(a,b){return b.i-a.i}),i=0;i<a.length;i++){var d=a[i];b.out.splice(d.i,1);var e=[],f=[];RED.nodes.eachLink(function(a){"subflow"==a.target.type&&a.target.z==b.id&&a.target.i==d.i&&e.push(a),a.source.type=="subflow:"+b.id&&(a.sourcePort==d.i?e.push(a):a.sourcePort>d.i&&f.push(a))}),e.forEach(function(a){RED.nodes.removeLink(a)}),f.forEach(function(a){a.sourcePort--}),c=c.concat(e);for(var g=d.i;g<b.out.length;g++)b.out[g].i--,b.out[g].dirty=!0}return b.changed=!0,{subflowOutputs:a,links:c}}}function g(a){var b=RED.nodes.subflow(RED.workspaces.active());h(b);var c=[];return b?(RED.nodes.filterNodes({type:"subflow:"+b.id}).forEach(function(d){for(c.push({id:d.id,changed:d.changed}),a&&(d.changed=!0),d.inputs=b["in"].length,d.outputs=b.out.length;d.outputs<d.ports.length;)d.ports.pop();d.resize=!0,d.dirty=!0,RED.editor.updateNodeProperties(d)}),RED.editor.validateNode(b),{instances:c}):void 0}function h(a){a&&($("#workspace-subflow-input-add").toggleClass("active",0!==a["in"].length),$("#workspace-subflow-input-remove").toggleClass("active",0===a["in"].length),$("#workspace-subflow-output .spinner-value").html(a.out.length))}function j(b){var i=$("#workspace-toolbar");i.empty(),$('<a class="button" id="workspace-subflow-edit" href="#" data-i18n="[append]subflow.editSubflowProperties"><i class="fa fa-pencil"></i> </a>').appendTo(i),$('<span style="margin-left: 5px;" data-i18n="subflow.input"></span> <div style="display: inline-block;" class="button-group"><a id="workspace-subflow-input-remove" class="button active" href="#">0</a><a id="workspace-subflow-input-add" class="button" href="#">1</a></div>').appendTo(i),$('<span style="margin-left: 5px;" data-i18n="subflow.output"></span> <div id="workspace-subflow-output" style="display: inline-block;" class="button-group spinner-group"><a id="workspace-subflow-output-remove" class="button" href="#"><i class="fa fa-minus"></i></a><div class="spinner-value">3</div><a id="workspace-subflow-output-add" class="button" href="#"><i class="fa fa-plus"></i></a></div>').appendTo(i),$('<a class="button" id="workspace-subflow-delete" href="#" data-i18n="[append]subflow.deleteSubflow"><i class="fa fa-trash"></i> </a>').appendTo(i),i.i18n(),$("#workspace-subflow-output-remove").click(function(a){a.preventDefault();var c=RED.nodes.dirty(),d=b.changed,e=f();if(e){var h=g(!0);RED.history.push({t:"delete",links:e.links,subflowOutputs:e.subflowOutputs,changed:d,dirty:c,subflow:{instances:h.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-output-add").click(function(a){a.preventDefault(),e()}),$("#workspace-subflow-input-add").click(function(a){a.preventDefault(),c()}),$("#workspace-subflow-input-remove").click(function(a){a.preventDefault();var c=RED.nodes.dirty(),e=b.changed;b.changed=!0;var f=d();if(f){var h=g(!0);RED.history.push({t:"delete",links:f.links,changed:e,subflowInputs:f.subflowInputs,
dirty:c,subflow:{instances:h.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-edit").click(function(a){RED.editor.editSubflow(RED.nodes.subflow(RED.workspaces.active())),a.preventDefault()}),$("#workspace-subflow-delete").click(function(b){b.preventDefault();var c=[],d=[],e=RED.nodes.dirty(),f=a();RED.nodes.eachNode(function(a){a.type=="subflow:"+f.id&&c.push(a),a.z==f.id&&c.push(a)}),RED.nodes.eachConfig(function(a){a.z==f.id&&c.push(a)});for(var g=[],h=0;h<c.length;h++){var i=RED.nodes.remove(c[h].id);d=d.concat(i.links),g=g.concat(i.nodes)}c=c.concat(g),RED.nodes.removeSubflow(f),RED.history.push({t:"delete",nodes:c,links:d,subflow:{subflow:f},dirty:e}),RED.workspaces.remove(f),RED.nodes.dirty(!0),RED.view.redraw()}),h(b),$("#chart").css({"margin-top":"40px"}),$("#workspace-toolbar").show()}function k(){$("#workspace-toolbar").hide().empty(),$("#chart").css({"margin-top":"0"})}function l(){RED.events.on("workspace:change",function(a){var b=RED.nodes.subflow(a.workspace);b?j(b):k()}),RED.events.on("view:selection-changed",function(a){a.nodes?RED.menu.setDisabled("menu-item-subflow-convert",!1):RED.menu.setDisabled("menu-item-subflow-convert",!0)})}function m(){var a=0;RED.nodes.eachSubflow(function(b){var c=new RegExp("^Subflow (\\d+)$").exec(b.name);c&&(a=Math.max(a,c[1]))});var b="Subflow "+(a+1),c=RED.nodes.id(),d={type:"subflow",id:c,name:b,info:"","in":[],out:[]};RED.nodes.addSubflow(d),RED.history.push({t:"createSubflow",subflow:{subflow:d},dirty:RED.nodes.dirty()}),RED.workspaces.show(c),RED.nodes.dirty(!0)}function n(){var a=RED.view.selection();if(!a.nodes)return void RED.notify(RED._("subflow.errors.noNodesSelected"),"error");var b,c={},d=[],e=[],f=[],g=[],h={},i=[a.nodes[0].x,a.nodes[0].y,a.nodes[0].x,a.nodes[0].y];for(b=0;b<a.nodes.length;b++){var j=a.nodes[b];c[j.id]={n:j,outputs:{}},i=[Math.min(i[0],j.x),Math.min(i[1],j.y),Math.max(i[2],j.x),Math.max(i[3],j.y)]}var k=[(i[2]+i[0])/2,(i[3]+i[1])/2];RED.nodes.eachLink(function(a){c[a.source.id]&&c[a.target.id],c[a.source.id]&&!c[a.target.id]&&(g.push(a),e.push(a)),!c[a.source.id]&&c[a.target.id]&&(f.push(a),h[a.target.id]=a.target,e.push(a))});var l={};if(g=g.filter(function(a){return l[a.source.id+":"+a.sourcePort]?(l[a.source.id+":"+a.sourcePort].targets.push(a.target),!1):(a.targets=[],a.targets.push(a.target),l[a.source.id+":"+a.sourcePort]=a,!0)}),g.sort(function(a,b){return a.source.y-b.source.y}),Object.keys(h).length>1)return void RED.notify(RED._("subflow.errors.multipleInputsToSelection"),"error");var m=0;RED.nodes.eachSubflow(function(a){var b=new RegExp("^Subflow (\\d+)$").exec(a.name);b&&(m=Math.max(m,b[1]))});var n="Subflow "+(m+1),o=RED.nodes.id(),p={type:"subflow",id:o,name:n,info:"","in":Object.keys(h).map(function(a,b){var c=b;return{type:"subflow",direction:"in",x:h[a].x-h[a].w/2-80,y:h[a].y,z:o,i:c,id:RED.nodes.id(),wires:[{id:h[a].id}]}}),out:g.map(function(a,b){var c=b;return{type:"subflow",direction:"in",x:a.source.x+a.source.w/2+80,y:a.source.y,z:o,i:c,id:RED.nodes.id(),wires:[{id:a.source.id,port:a.sourcePort}]}})};RED.nodes.addSubflow(p);var q={id:RED.nodes.id(),type:"subflow:"+p.id,x:k[0],y:k[1],z:RED.workspaces.active(),inputs:p["in"].length,outputs:p.out.length,h:Math.max(30,15*(p.out.length||0)),changed:!0};for(q._def=RED.nodes.getType(q.type),RED.editor.validateNode(q),RED.nodes.add(q),f.forEach(function(a){var b={source:a.source,sourcePort:a.sourcePort,target:q};d.push(b),RED.nodes.addLink(b)}),g.forEach(function(a,b){a.targets.forEach(function(a){var c={source:q,sourcePort:b,target:a};d.push(c),RED.nodes.addLink(c)})}),p["in"].forEach(function(a){a.wires.forEach(function(b){var c={source:a,sourcePort:0,target:RED.nodes.node(b.id)};d.push(c),RED.nodes.addLink(c)})}),p.out.forEach(function(a,b){a.wires.forEach(function(b){var c={source:RED.nodes.node(b.id),sourcePort:b.port,target:a};d.push(c),RED.nodes.addLink(c)})}),b=0;b<e.length;b++)RED.nodes.removeLink(e[b]);for(b=0;b<a.nodes.length;b++)a.nodes[b].z=p.id;RED.history.push({t:"createSubflow",nodes:[q.id],links:d,subflow:{subflow:p},activeWorkspace:RED.workspaces.active(),removedLinks:e,dirty:RED.nodes.dirty()}),RED.editor.validateNode(p),RED.nodes.dirty(!0),RED.view.redraw(!0)}return{init:l,createSubflow:m,convertToSubflow:n,refresh:g,removeInput:d,removeOutput:f}}(),RED.touch=RED.touch||{},RED.touch.radialMenu=function(){function a(a,f,g){c=!0;try{$("body").width(),$("body").height();b=d3.select("body").append("div").style({position:"absolute",top:0,left:0,bottom:0,right:0,"z-index":1e3}).on("touchstart",function(){q(),d3.event.preventDefault()});for(var h=b.append("div").style({position:"absolute",top:f[1]-80+"px",left:f[0]-80+"px","border-radius":"80px",width:"160px",height:"160px",background:"rgba(255,255,255,0.6)",border:"1px solid #666"}),i=[],j=function(a,b,c){c.el=h.append("div").style({position:"absolute",top:b+80-25+"px",left:a+80-25+"px","border-radius":"20px",width:"50px",height:"50px",background:"#fff",border:"2px solid #666","text-align":"center","line-height":"50px"}),c.el.html(c.name),c.disabled&&c.el.style({"border-color":"#ccc",color:"#ccc"}),c.x=a,c.y=b,i.push(c),c.el.on("touchstart",function(){c.el.style("background","#999"),d3.event.preventDefault(),d3.event.stopPropagation()}),c.el.on("touchend",function(){q(),c.onselect(),d3.event.preventDefault(),d3.event.stopPropagation()})},k=g.length,l=Math.max(Math.PI/(k-1),Math.PI/4),m=Math.PI,n=0;k>n;n++){var o=Math.floor(80*Math.cos(m)),p=Math.floor(80*Math.sin(m));g[n].name&&j(o,p,g[n]),m+=l}var q=function(){c=!1,e=null,b.remove(),b=null};a.on("touchend.radial",function(){if(a.on("touchend.radial",null),a.on("touchmenu.radial",null),e){try{e.onselect()}catch(b){RED._debug(b)}q()}else d&&q()}),a.on("touchmove.radial",function(){try{for(var a=d3.event.touches.item(0),b=[a.pageX-f[0],a.pageY-f[1]],c=0;c<i.length;c++){var g=i[c];g.disabled||(b[0]>g.x-30&&b[0]<g.x+30&&b[1]>g.y-30&&b[1]<g.y+30?g!==e&&(g.el.style("background","#999"),e=g):g===e?(g.el.style("background","#fff"),e=null):g.el.style("background","#fff"))}if(!e){var h=Math.abs(b[0]*b[0]+b[1]*b[1]);d=h>6400}}catch(j){RED._debug(j)}})}catch(r){RED._debug(r)}}var b=null,c=!1,d=!1,e=null;return{show:a,active:function(){return c}}}();